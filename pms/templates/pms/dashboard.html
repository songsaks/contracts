{% extends 'pms/base_pms.html' %}
{% load humanize %}

{% block extra_css %}
<style>
    .analytics-card {
        border: none;
        border-radius: 20px;
        background: white;
        transition: all 0.3s ease;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .stat-badge {
        font-size: 0.75rem;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 10px;
        background: rgba(79, 70, 229, 0.1);
        color: var(--primary-color);
    }

    .rank-item {
        padding: 1rem;
        border-radius: 16px;
        background: #f8fafc;
        margin-bottom: 0.75rem;
        border: 1px solid #f1f5f9;
        transition: all 0.2s;
    }

    .rank-item:hover {
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-color: var(--primary-color);
    }

    .owner-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.1rem;
    }

    .progress {
        height: 8px;
        border-radius: 4px;
        background: #e2e8f0;
    }

    @media (max-width: 767.98px) {
        .chart-container {
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4 mb-4">
    <!-- Page Header -->
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h1 class="page-heading mb-0">
            <i class="fas fa-chart-pie me-2 text-primary" style="font-size: 0.85em;"></i>
            Business Dashboard
        </h1>
        <div class="stat-badge">
            <i class="far fa-calendar-alt me-1"></i>อัปเดตล่าสุด: {% now "d M H:i" %}
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="col-md-4">
        <div class="card analytics-card shadow-sm h-100 p-3">
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle bg-primary bg-opacity-10 text-primary p-3">
                    <i class="fas fa-coins fa-2x"></i>
                </div>
                <div>
                    <div class="text-muted small fw-bold uppercase ls-1">ยอดขายรวมทั้งหมด</div>
                    <div class="h3 fw-800 mb-0">฿{{ total_revenue|floatformat:0|intcomma }}</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card analytics-card shadow-sm h-100 p-3">
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle bg-success bg-opacity-10 text-success p-3">
                    <i class="fas fa-briefcase fa-2x"></i>
                </div>
                <div>
                    <div class="text-muted small fw-bold uppercase ls-1">งานที่กำลังดำเนินการ</div>
                    <div class="h3 fw-800 mb-0">{{ active_projects }} <span class="text-muted fs-6">รายการ</span></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card analytics-card shadow-sm h-100 p-3">
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle bg-info bg-opacity-10 text-info p-3">
                    <i class="fas fa-layer-group fa-2x"></i>
                </div>
                <div>
                    <div class="text-muted small fw-bold uppercase ls-1">รวมงานสะสม</div>
                    <div class="h3 fw-800 mb-0">{{ total_projects }} <span class="text-muted fs-6">รายการ</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Monthly Trends Chart -->
    <div class="col-lg-8">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-chart-line me-2 text-primary"></i>แนวโน้มยอดขายรายเดือน</h5>
            <div class="chart-container">
                <canvas id="monthlySalesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Job Type Pie Distribution -->
    <div class="col-lg-4">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-chart-pie me-2 text-primary"></i>สัดส่วนประเภทงาน</h5>
            <div class="chart-container">
                <canvas id="typeDistChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Sales By Person / Ranking -->
    <div class="col-lg-6">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-users me-2 text-primary"></i>ผลงานแยกตามรายบุคคล</h5>
            <div class="chart-container">
                <canvas id="ownerSalesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Customers Char -->
    <div class="col-lg-6">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-building-user me-2 text-primary"></i>10 อันดับลูกค้ายอดขายชูงสุด</h5>
            <div class="chart-container">
                <canvas id="customerSalesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Performers List -->
    <div class="col-lg-6">
        <div class="card analytics-card shadow-sm p-4">
            <h5 class="fw-800 mb-4"><i class="fas fa-medal me-2 text-warning"></i>อันดับยอดขายยอดเยี่ยม</h5>
            <div class="ranking-list">
                {% for owner in sales_by_owner %}
                {% if owner.total_sales %}
                <div class="rank-item d-flex align-items-center gap-3">
                    <div class="owner-avatar">
                        {{ owner.name|slice:":1" }}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold">{{ owner.name }}</span>
                            <span class="fw-800 text-primary">฿{{ owner.total_sales|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="progress">
                             <div class="progress-bar bg-primary" style="width: {{ owner.performance_pct }}%"></div>
                        </div>
                        <div class="small text-muted mt-1">{{ owner.job_count }} โครงการ</div>
                    </div>
                </div>
                {% endif %}
                {% empty %}
                <p class="text-center text-muted py-5">ยังไม่มีข้อมูลยอดขาย</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const primaryColor = '#4f46e5';
        const successColor = '#10b981';
        const infoColor = '#0ea5e9';
        const secondaryColor = '#8b5cf6';
        
        // 1. Monthly Trends Chart
        const ctxMonthly = document.getElementById('monthlySalesChart').getContext('2d');
        new Chart(ctxMonthly, {
            type: 'bar',
            data: {
                labels: {{ chart_months|safe }},
                datasets: [
                    {
                        label: 'โครงการ',
                        data: {{ chart_project_series|safe }},
                        backgroundColor: primaryColor,
                        borderRadius: 6,
                    },
                    {
                        label: 'งานขาย',
                        data: {{ chart_service_series|safe }},
                        backgroundColor: successColor,
                        borderRadius: 6,
                    },
                    {
                        label: 'งานซ่อม',
                        data: {{ chart_repair_series|safe }},
                        backgroundColor: infoColor,
                        borderRadius: 6,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { 
                        stacked: true, 
                        beginAtZero: true,
                        ticks: {
                            callback: value => '฿' + (value/1000).toFixed(0) + 'k'
                        }
                    }
                },
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: '600' } } }
                }
            }
        });

        // 2. Job Type Pie Chart
        const ctxTypeDist = document.getElementById('typeDistChart').getContext('2d');
        new Chart(ctxTypeDist, {
            type: 'doughnut',
            data: {
                labels: {{ chart_type_labels|safe }},
                datasets: [{
                    data: {{ chart_type_values|safe }},
                    backgroundColor: [primaryColor, successColor, infoColor, secondaryColor],
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                }
            }
        });

        // 3. Sales By Owner Chart
        const ctxOwners = document.getElementById('ownerSalesChart').getContext('2d');
        new Chart(ctxOwners, {
            type: 'horizontalBar', // Note: in Chart.js 3+ this is handled by indexAxis: 'y'
            data: {
                labels: {{ chart_owners|safe }},
                datasets: [{
                    label: 'ยอดขายรายบุคคล',
                    data: {{ chart_owner_sales|safe }},
                    backgroundColor: primaryColor,
                    borderRadius: 8,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { 
                        beginAtZero: true,
                        ticks: { callback: value => '฿' + (value/1000).toFixed(0) + 'k' }
                    },
                    y: { grid: { display: false } }
                }
            }
        });
        // 4. Top Customers Chart (Stacked)
        const ctxCustomers = document.getElementById('customerSalesChart').getContext('2d');
        new Chart(ctxCustomers, {
            type: 'bar',
            data: {
                labels: {{ chart_customers|safe }},
                datasets: [
                    {
                        label: 'ปิดงานแล้ว',
                        data: {{ chart_customer_closed|safe }},
                        backgroundColor: successColor, // Green for completed
                        borderRadius: 6,
                    },
                    {
                        label: 'อยู่ระหว่างดำเนินการ',
                        data: {{ chart_customer_active|safe }},
                        backgroundColor: primaryColor, // Blue for active
                        borderRadius: 6,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        display: true, 
                        position: 'bottom',
                        labels: { usePointStyle: true }
                    } 
                },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { 
                        stacked: true,
                        beginAtZero: true,
                        ticks: { callback: value => '฿' + (value/1000).toFixed(0) + 'k' }
                    }
                }
            }
        });
    });
</script>
{% endblock %}

