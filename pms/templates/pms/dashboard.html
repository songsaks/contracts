{% extends 'pms/base_pms.html' %}
{% load humanize %}

{% block extra_css %}
<style>
    .analytics-card {
        border: none;
        border-radius: 20px;
        background: white;
        transition: all 0.3s ease;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .stat-badge {
        font-size: 0.75rem;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 10px;
        background: rgba(79, 70, 229, 0.1);
        color: var(--primary-color);
    }

    .rank-item {
        padding: 1rem;
        border-radius: 16px;
        background: #f8fafc;
        margin-bottom: 0.75rem;
        border: 1px solid #f1f5f9;
        transition: all 0.2s;
    }

    .rank-item:hover {
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-color: var(--primary-color);
    }

    .owner-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.1rem;
    }

    .progress {
        height: 8px;
        border-radius: 4px;
        background: #e2e8f0;
    }

    @media (max-width: 767.98px) {
        .chart-container {
            height: 250px;
        }
    }

    /* AI Analysis Premium Styles */
    .ai-card {
        border-radius: 30px;
        background: linear-gradient(145deg, #ffffff, #f1f5f9);
        border: 1px solid rgba(79, 70, 229, 0.1);
        box-shadow: 0 20px 40px rgba(0,0,0,0.05);
        overflow: hidden;
        position: relative;
    }

    .ai-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(79, 70, 229, 0.05) 0%, transparent 70%);
        z-index: 0;
    }

    .ai-badge {
        background: linear-gradient(90deg, #4f46e5, #7c3aed);
        color: white;
        padding: 6px 16px;
        border-radius: 50px;
        font-weight: 700;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }

    #aiContent {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        color: #1e293b;
        border-radius: 20px;
    }

    #aiContent h1, #aiContent h2, #aiContent h3 {
        color: #4f46e5;
        font-weight: 800;
        margin-top: 1.5rem;
    }

    #aiContent ul {
        padding-left: 1.2rem;
    }

    #aiContent li {
        margin-bottom: 0.5rem;
    }

    .robot-icon {
        animation: pulse 2s infinite ease-in-out;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    .btn-ai-analyze {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border: none;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .btn-ai-analyze:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 15px 30px rgba(79, 70, 229, 0.3);
        background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
    }

    .ai-loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4 mb-4">
    <!-- Page Header -->
    <div class="col-12">
        <div class="card analytics-card shadow-sm p-4">
            <div class="row align-items-center g-3">
                <div class="col-md-6 text-center text-md-start">
                    <h1 class="page-heading mb-0">
                        <i class="fas fa-chart-pie me-2 text-primary" style="font-size: 0.85em;"></i>
                        Business Dashboard
                    </h1>
                    <p class="text-muted small mb-0 mt-2">วิเคราะห์ข้อมูลสรุปผลการดำเนินงานรายเดือน</p>
                </div>
                <div class="col-md-6">
                    <form method="get" class="d-flex flex-wrap justify-content-md-end gap-2 align-items-center" id="filterForm">
                        <!-- Mode Selector -->
                        <div class="btn-group btn-group-sm rounded-pill shadow-sm bg-light p-1" role="group">
                            <input type="radio" class="btn-check" name="mode" id="modeDaily" value="daily" {% if mode == 'daily' %}checked{% endif %} onchange="toggleInputs()">
                            <label class="btn btn-sm rounded-pill px-3 {% if mode == 'daily' %}btn-white shadow-sm fw-bold{% else %}text-muted{% endif %}" for="modeDaily" id="labelDaily">รายวัน</label>
                            
                            <input type="radio" class="btn-check" name="mode" id="modeMonthly" value="monthly" {% if mode == 'monthly' or not mode %}checked{% endif %} onchange="toggleInputs()">
                            <label class="btn btn-sm rounded-pill px-3 {% if mode == 'monthly' or not mode %}btn-white shadow-sm fw-bold{% else %}text-muted{% endif %}" for="modeMonthly" id="labelMonthly">รายเดือน</label>
                            
                            <input type="radio" class="btn-check" name="mode" id="modeYearly" value="yearly" {% if mode == 'yearly' %}checked{% endif %} onchange="toggleInputs()">
                            <label class="btn btn-sm rounded-pill px-3 {% if mode == 'yearly' %}btn-white shadow-sm fw-bold{% else %}text-muted{% endif %}" for="modeYearly" id="labelYearly">รายปี</label>
                        </div>

                        <!-- Daily Input (Range) -->
                        <div class="filter-input-group d-flex align-items-center gap-2 {% if mode != 'daily' %}d-none{% endif %}" id="groupDaily">
                            <input type="date" name="start_date" class="form-control form-control-sm border-0 bg-light rounded-pill px-3" value="{{ date_start|default:date_filter }}" title="เริ่มวันที่">
                            <span class="text-muted small">ถึง</span>
                            <input type="date" name="end_date" class="form-control form-control-sm border-0 bg-light rounded-pill px-3" value="{{ date_end|default:date_filter }}" title="ถึงวันที่">
                        </div>

                        <!-- Month/Year Inputs -->
                        <div class="filter-input-group d-flex gap-2 {% if mode == 'daily' %}d-none{% endif %}" id="groupMonthYear">
                            <select name="month" class="form-select form-select-sm border-0 bg-light rounded-pill px-3 {% if mode == 'yearly' %}d-none{% endif %}" style="min-width: 120px;" id="monthInput">
                                {% for val, label in month_choices %}
                                <option value="{{ val }}" {% if month_filter == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <select name="year" class="form-select form-select-sm border-0 bg-light rounded-pill px-3" style="min-width: 90px;">
                                {% for y in year_choices %}
                                <option value="{{ y }}" {% if year_filter == y %}selected{% endif %}>{{ y }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary btn-sm rounded-circle shadow-sm" style="width: 32px; height: 32px;">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>

                    <script>
                    function toggleInputs() {
                        const mode = document.querySelector('input[name="mode"]:checked').value;
                        const groupDaily = document.getElementById('groupDaily');
                        const groupMonthYear = document.getElementById('groupMonthYear');
                        const monthInput = document.getElementById('monthInput');
                        
                        // Update Labels
                        document.querySelectorAll('.btn-group label').forEach(lbl => {
                            lbl.classList.remove('btn-white', 'shadow-sm', 'fw-bold');
                            lbl.classList.add('text-muted');
                        });
                        const activeId = 'label' + mode.charAt(0).toUpperCase() + mode.slice(1);
                        const activeLabel = document.getElementById(activeId);
                        if(activeLabel) {
                            activeLabel.classList.remove('text-muted');
                            activeLabel.classList.add('btn-white', 'shadow-sm', 'fw-bold');
                        }

                        if (mode === 'daily') {
                            groupDaily.classList.remove('d-none');
                            groupMonthYear.classList.add('d-none');
                        } else {
                            groupDaily.classList.add('d-none');
                            groupMonthYear.classList.remove('d-none');
                            
                            if (mode === 'yearly') {
                                monthInput.classList.add('d-none');
                            } else {
                                monthInput.classList.remove('d-none');
                            }
                        }
                    }
                    </script>
                    <style>
                        .btn-white {
                            background-color: white;
                            color: var(--bs-primary);
                        }
                    </style>
                </div>
            </div>
        </div>
    </div>


    <!-- Row 1: Summary Stats - 3 Rows of 2 Columns -->
    <div class="col-md-6 mb-4">
        <div class="card analytics-card shadow-sm h-100 p-4" style="border-left: 6px solid #10b981; border-radius: 18px; background: #fff;">
            <div class="d-flex align-items-center gap-4">
                <div class="bg-success bg-opacity-10 text-success p-4 rounded-4">
                    <i class="fas fa-hand-holding-usd fa-3x"></i>
                </div>
                <div>
                    <div class="text-dark mb-1" style="font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">ยอดขายที่ปิดจบ</div>
                    <div class="fw-900 mb-0" style="font-size: 2.8rem; letter-spacing: -1.5px; color: #10b981; line-height: 1.1;">฿{{ actual_sales|floatformat:0|intcomma }}</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card analytics-card shadow-sm h-100 p-4" style="border-left: 6px solid #4f46e5; border-radius: 18px; background: #fff;">
            <div class="d-flex align-items-center gap-4">
                <div class="bg-primary bg-opacity-10 text-primary p-4 rounded-4">
                    <i class="fas fa-coins fa-3x"></i>
                </div>
                <div>
                    <div class="text-dark mb-1" style="font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">ยอดรวมงานทั้งหมด</div>
                    <div class="fw-900 mb-0" style="font-size: 2.8rem; letter-spacing: -1.5px; color: #4f46e5; line-height: 1.1;">฿{{ total_job_value|floatformat:0|intcomma }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card analytics-card shadow-sm h-100 p-4" style="border-left: 6px solid #ef4444; border-radius: 18px; background: #fff;">
            <div class="d-flex align-items-center gap-4">
                <div class="bg-danger bg-opacity-10 text-danger p-4 rounded-4">
                    <i class="fas fa-ban fa-3x"></i>
                </div>
                <div>
                    <div class="text-dark mb-1" style="font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">งานที่ยกเลิก</div>
                    <div class="fw-900 mb-0" style="font-size: 2.8rem; letter-spacing: -1.5px; color: #ef4444; line-height: 1.1;">{{ cancelled_count }} <span style="font-size: 1.5rem; color: #6b7280; font-weight: 600;">งาน</span></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card analytics-card shadow-sm h-100 p-4" style="border-left: 6px solid #6b7280; border-radius: 18px; background: #fff;">
            <div class="d-flex align-items-center gap-4">
                <div class="bg-secondary bg-opacity-10 text-secondary p-4 rounded-4">
                    <i class="fas fa-file-invoice-dollar fa-3x"></i>
                </div>
                <div>
                    <div class="text-dark mb-1" style="font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">มูลค่างานที่ยกเลิก</div>
                    <div class="fw-900 mb-0" style="font-size: 2.8rem; letter-spacing: -1.5px; color: #374151; line-height: 1.1;">฿{{ cancelled_value|floatformat:0|intcomma }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card analytics-card shadow-sm h-100 p-4" style="border-left: 6px solid #f59e0b; border-radius: 18px; background: #fff;">
            <div class="d-flex align-items-center gap-4">
                <div class="bg-warning bg-opacity-10 text-warning p-4 rounded-4">
                    <i class="fas fa-tools fa-3x"></i>
                </div>
                <div>
                    <div class="text-dark mb-1" style="font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">งานที่กำลังดำเนินการ</div>
                    <div class="fw-900 mb-0" style="font-size: 2.8rem; letter-spacing: -1.5px; color: #d97706; line-height: 1.1;">{{ active_projects }} <span style="font-size: 1.5rem; color: #6b7280; font-weight: 600;">งาน</span></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card analytics-card shadow-sm h-100 p-4" style="border-left: 6px solid #06b6d4; border-radius: 18px; background: #fff;">
            <div class="d-flex align-items-center gap-4">
                <div class="bg-info bg-opacity-10 text-info p-4 rounded-4">
                    <i class="fas fa-layer-group fa-3x"></i>
                </div>
                <div>
                    <div class="text-dark mb-1" style="font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">รวมงานสะสม</div>
                    <div class="fw-900 mb-0" style="font-size: 2.8rem; letter-spacing: -1.5px; color: #0891b2; line-height: 1.1;">{{ total_projects }} <span style="font-size: 1.5rem; color: #6b7280; font-weight: 600;">งาน</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 1.5: Completion Analysis (Quantity & Value) -->
    <div class="col-lg-6">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-check-circle me-2 text-success"></i>เปรียบเทียบจำนวนงาน (Total vs Closed)</h5>
            <div class="chart-container" style="height: 350px;">
                <canvas id="completionChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-coins me-2 text-warning"></i>เปรียบเทียบมูลค่างาน (Total Value vs Closed)</h5>
            <div class="chart-container" style="height: 350px;">
                <canvas id="completionValueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Row 2: Monthly Trends -->
    <div class="col-lg-6">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-chart-line me-2 text-primary"></i>แนวโน้มยอดขายรายเดือน (แยกตามประเภท)</h5>
            <div class="chart-container">
                <canvas id="monthlySalesChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-users-cog me-2 text-primary"></i>แนวโน้มยอดขายรายบุคคล (รายเดือน)</h5>
            <div class="chart-container">
                <canvas id="ownerTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Row 3: Performance Analysis -->
    <div class="col-lg-4">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-chart-pie me-2 text-primary"></i>สัดส่วนประเภทงาน</h5>
            <div class="chart-container" style="height: 250px;">
                <canvas id="typeDistChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card analytics-card shadow-sm p-4 h-100">
            <h5 class="fw-800 mb-4"><i class="fas fa-trophy me-2 text-primary"></i>10 อันดับลูกค้า</h5>
            <div class="chart-container" style="height: 300px;">
                <canvas id="customerSalesChart"></canvas>
            </div>
        </div>
    </div>


    <!-- Row 4: Rankings List -->
    <div class="col-12">
        <div class="card analytics-card shadow-sm p-4">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h5 class="fw-800 mb-0"><i class="fas fa-medal me-2 text-warning"></i>อันดับผลงานดีเลิศ ประจำปี {{ year_filter }}</h5>
                <span class="badge bg-light text-dark rounded-pill px-3">Top Performers</span>
            </div>
            <div class="row g-3">
                {% for owner in sales_by_owner %}
                {% if owner.total_sales %}
                <div class="col-md-6 col-lg-4">
                    <div class="rank-item d-flex align-items-center gap-3 h-100">
                        <div class="owner-avatar">
                            {{ owner.name|slice:":1" }}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="fw-bold">{{ owner.name }}</span>
                                <span class="fw-800 text-primary">฿{{ owner.total_sales|floatformat:0|intcomma }}</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                 <div class="progress-bar bg-primary rounded-pill" style="width: {{ owner.performance_pct }}%"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <span class="small text-muted">{{ owner.job_count }} โครงการ</span>
                                <span class="small fw-bold text-primary">{{ owner.performance_pct|floatformat:1 }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% empty %}
                <div class="col-12 text-center text-muted py-5">
                    <i class="fas fa-folder-open fa-3x mb-3 opacity-25"></i>
                    <p>ยังไม่มีข้อมูลยอดขายในระบบ</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- AI Analysis Section (Moved to Bottom) -->
    <div class="col-12 mt-5">
        <div class="card ai-card">
            <div class="card-body p-4 p-md-5 position-relative" style="z-index: 1;">
                <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-4">
                    <div class="text-center text-md-start">
                        <div class="d-inline-flex align-items-center gap-2 ai-badge small mb-3">
                            <i class="fas fa-robot robot-icon"></i>
                            <span>AI BUSINESS INSIGHTS</span>
                        </div>
                        <h2 class="fw-900 text-dark mb-2" style="letter-spacing: -0.5px;">บทวิเคราะห์ธุรกิจอัจฉริยะ</h2>
                        <p class="text-secondary fs-5 mb-0 opacity-75">รับคำแนะนำเชิงกลยุทธ์และการสรุปผลภาพรวมด้วยขุมพลัง Gemini AI</p>
                    </div>
                    <button id="btnAiAnalyze" class="btn btn-ai-analyze btn-lg text-white rounded-pill px-5 py-3 d-flex align-items-center gap-3 shadow-lg">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span class="fw-bold">ประมวลผลการวิเคราะห์</span>
                    </button>
                </div>

                <!-- AI Response Container -->
                <div id="aiResponseArea" class="mt-5 d-none">
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="h-px bg-primary bg-opacity-25 flex-grow-1"></div>
                        <span class="small fw-bold text-primary text-uppercase ls-2">Analysis Result</span>
                        <div class="h-px bg-primary bg-opacity-25 flex-grow-1"></div>
                    </div>
                    
                    <div id="aiLoading" class="ai-loading-container d-none">
                        <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                        <div class="fw-bold text-primary h5">กำลังวิเคราะห์ข้อมูลเชิงลึก...</div>
                        <p class="text-muted small">ระบบกำลังใช้ AI ประมวลผลข้อมูลยอดขายและแนวโน้มธุรกิจของคุณ</p>
                    </div>

                    <div id="aiContent" class="markdown-body p-4 p-md-5 shadow-inner" style="font-size: 1.1rem; line-height: 2;">
                        <!-- AI Analysis will be injected here -->
                    </div>

                    <div class="text-center mt-4 opacity-50 small">
                        <i class="fas fa-info-circle me-1"></i> ผลลัพธ์นี้ถูกสร้างขึ้นโดย AI โปรดใช้ดุลยพินิจในการประกอบการตัดสินใจ
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const pmsBlue = '#4f46e5';
        const pmsGreen = '#10b981';
        const pmsOrange = '#f59e0b';
        const secondaryColor = '#8b5cf6';
        
        // Monthly Trends by Person Chart
        const ctxOwnerTrends = document.getElementById('ownerTrendChart').getContext('2d');
        new Chart(ctxOwnerTrends, {
            type: 'line',
            data: {
                labels: {{ chart_months|safe }},
                datasets: {{ chart_owner_trends|safe }}
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: { boxWidth: 12, usePointStyle: true, font: { size: 11 } }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += '฿' + context.parsed.y.toLocaleString();
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { 
                        beginAtZero: true,
                        ticks: { callback: value => '฿' + (value/1000).toFixed(0) + 'k' }
                    }
                }
            }
        });

        // Completion Analysis Chart (Total vs Closed)
        const ctxCompletion = document.getElementById('completionChart').getContext('2d');
        new Chart(ctxCompletion, {
            type: 'bar',
            data: {
                labels: {{ chart_months|safe }},
                datasets: [
                    {
                        label: 'งานรับเข้าทั้งหมด (Total)',
                        data: {{ chart_completion_total|safe }},
                        backgroundColor: '#94a3b8', // Slate-400
                        borderRadius: 4,
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    },
                    {
                        label: 'งานปิดจบแล้ว (Closed)',
                        data: {{ chart_completion_closed|safe }},
                        backgroundColor: '#10b981', // Emerald-500
                        borderRadius: 4,
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { 
                        position: 'top', 
                        align: 'end',
                        labels: { usePointStyle: true, font: { weight: 'bold' } } 
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1e293b',
                        bodyColor: '#475569',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += context.raw + ' งาน';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        grid: { display: false }
                    },
                    y: { 
                        beginAtZero: true,
                        grid: { borderDash: [4, 4], color: '#f1f5f9' },
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });

        // Completion Value Analysis Chart (Total Value vs Closed Value)
        const ctxCompletionValue = document.getElementById('completionValueChart').getContext('2d');
        new Chart(ctxCompletionValue, {
            type: 'bar',
            data: {
                labels: {{ chart_months|safe }},
                datasets: [
                    {
                        label: 'มูลค่างานรับเข้า (Total)',
                        data: {{ chart_completion_total_value|safe }},
                        backgroundColor: '#a5b4fc', // Indigo-300
                        borderRadius: 4,
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    },
                    {
                        label: 'มูลค่างานปิดจบ (Closed)',
                        data: {{ chart_completion_closed_value|safe }},
                        backgroundColor: '#f59e0b', // Amber-500
                        borderRadius: 4,
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { 
                        position: 'top', 
                        align: 'end',
                        labels: { usePointStyle: true, font: { weight: 'bold' } } 
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1e293b',
                        bodyColor: '#475569',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += '฿' + context.parsed.y.toLocaleString();
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        grid: { display: false }
                    },
                    y: { 
                        beginAtZero: true,
                        grid: { borderDash: [4, 4], color: '#f1f5f9' },
                        ticks: { 
                             callback: value => '฿' + (value/1000).toFixed(0) + 'k'
                        }
                    }
                }
            }
        });

        // Sales by Month Chart (Updated layout/options)
        const ctxMonthly = document.getElementById('monthlySalesChart').getContext('2d');
        new Chart(ctxMonthly, {
            type: 'bar',
            data: {
                labels: {{ chart_months|safe }},
                datasets: [
                    {
                        label: 'โครงการ',
                        data: {{ chart_project_series|safe }},
                        backgroundColor: pmsBlue,
                        borderRadius: 6,
                    },
                    {
                        label: 'งานขาย',
                        data: {{ chart_service_series|safe }},
                        backgroundColor: pmsGreen,
                        borderRadius: 6,
                    },
                    {
                        label: 'งานซ่อม',
                        data: {{ chart_repair_series|safe }},
                        backgroundColor: pmsOrange,
                        borderRadius: 6,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { 
                        stacked: true, 
                        beginAtZero: true,
                        ticks: {
                            callback: value => '฿' + (value/1000).toFixed(0) + 'k'
                        }
                    }
                },
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: '600' } } }
                }
            }
        });

        // 2. Job Type Pie Chart
        const ctxTypeDist = document.getElementById('typeDistChart').getContext('2d');
        new Chart(ctxTypeDist, {
            type: 'doughnut',
            data: {
                labels: {{ chart_type_labels|safe }},
                datasets: [{
                    data: {{ chart_type_values|safe }},
                    backgroundColor: [pmsBlue, pmsGreen, pmsOrange],
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                }
            }
        });

        // 4. Top Customers Chart
        const ctxCustomers = document.getElementById('customerSalesChart').getContext('2d');
        new Chart(ctxCustomers, {
            type: 'bar',
            data: {
                labels: {{ chart_customers|safe }},
                datasets: [
                    {
                        label: 'ปิดงานแล้ว',
                        data: {{ chart_customer_closed|safe }},
                        backgroundColor: pmsGreen, // Green for completed
                        borderRadius: 6,
                    },
                    {
                        label: 'อยู่ระหว่างดำเนินการ',
                        data: {{ chart_customer_active|safe }},
                        backgroundColor: pmsBlue, // Blue for active
                        borderRadius: 6,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        display: true, 
                        position: 'bottom',
                        labels: { usePointStyle: true }
                    } 
                },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { 
                        stacked: true,
                        beginAtZero: true,
                        ticks: { callback: value => '฿' + (value/1000).toFixed(0) + 'k' }
                    }
                }
            }
        });
    });
</script>

<!-- Add Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.getElementById('btnAiAnalyze').addEventListener('click', function() {
        const btn = this;
        const responseArea = document.getElementById('aiResponseArea');
        const loading = document.getElementById('aiLoading');
        const content = document.getElementById('aiContent');
        
        // UI State
        responseArea.classList.remove('d-none');
        loading.classList.remove('d-none');
        content.classList.add('d-none');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-grow spinner-grow-sm me-2"></span> กำลังประมวลผล...';

        // Smooth scroll to loading area
        responseArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Prepare context params (month/year from current filter)
        const urlParams = new URLSearchParams(window.location.search);
        const month = urlParams.get('month') || '';
        const year = urlParams.get('year') || '';

        fetch(`{% url 'pms:ai_dashboard_analysis' %}?month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                loading.classList.add('d-none');
                content.classList.remove('d-none');
                
                if (data.status === 'success') {
                    content.innerHTML = marked.parse(data.analysis);
                    // Scroll to top of content
                    setTimeout(() => {
                        content.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    content.innerHTML = '<div class="alert alert-danger shadow-sm border-0 rounded-4 p-4"><i class="fas fa-exclamation-triangle me-2"></i> เกิดข้อผิดพลาดในการเรียกใช้ AI กรุณาลองใหม่ภายหลัง</div>';
                }
            })
            .catch(error => {
                console.error('AI Error:', error);
                loading.classList.add('d-none');
                content.classList.remove('d-none');
                content.innerHTML = '<div class="alert alert-danger shadow-sm border-0 rounded-4 p-4"><i class="fas fa-wifi-slash me-2"></i> ไม่สามารถเชื่อมต่อกับ AI ได้</div>';
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> ประมวลผลอีกครั้ง';
            });
    });
</script>
{% endblock %}

