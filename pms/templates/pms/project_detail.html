{% extends 'pms/base_pms.html' %}
{% load humanize %}

{% block content %}
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">
                {{ project.name }} 
                <span class="badge bg-{{ theme_color|default:'primary' }} {% if theme_color == 'warning' %}text-dark{% endif %} align-middle fs-4 ms-2">{{ current_status_label }}</span>
                <span class="badge bg-{{ theme_color|default:'secondary' }} bg-opacity-75 align-middle fs-6 ms-1">
                    {% if project.job_type == 'SERVICE' %}
                        <i class="fas fa-shopping-cart me-1"></i>
                    {% elif project.job_type == 'REPAIR' %}
                        <i class="fas fa-tools me-1"></i>
                    {% else %}
                        <i class="fas fa-project-diagram me-1"></i>
                    {% endif %}
                    {{ project.get_job_type_display }}
                </span>
            </h1>
            <div class="text-muted fs-5">
                ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <strong>{{ project.customer.name }}</strong> | 
                ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <strong>{{ project.owner.name|default:"-" }}</strong>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2">
            <a href="{% url 'pms:project_quotation' project.pk %}" class="btn btn-light text-dark shadow-sm border rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;" target="_blank" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤">
                <i class="fas fa-print"></i>
            </a>
            {% if active_queue_item %}
            <button class="btn btn-secondary shadow-sm rounded-circle d-flex align-items-center justify-content-center opacity-50" style="width: 40px; height: 40px;" disabled title="‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
                <i class="fas fa-lock"></i>
            </button>
            {% elif project.status == 'CLOSED' %}
            <button onclick="unlockClosedProject()" class="btn btn-dark shadow-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;" title="‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏à‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™)">
                <i class="fas fa-unlock"></i>
            </button>
            {% else %}

            <a href="{% url 'pms:project_update' project.pk %}" class="btn btn-{{ theme_color|default:'primary' }} text-white shadow-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                <i class="fas fa-pen"></i>
            </a>
            {% endif %}
            <a href="{% url 'pms:project_list' %}" class="btn btn-light text-secondary shadow-sm border rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;" title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </div>

    {% if project.status == 'CLOSED' %}
    <div class="alert alert-dark border-0 shadow-sm mb-4 d-flex align-items-center">
        <i class="fas fa-check-double fs-4 me-3 text-success"></i>
        <div>
            <strong>‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô 
            ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
        </div>
    </div>
    {% elif active_queue_item %}

    <div class="alert alert-warning border-0 shadow-sm mb-4 d-flex align-items-center">
        <i class="fas fa-info-circle fs-4 me-3"></i>
        <div>
            <strong>‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å:</strong> ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á 
            <a href="{% url 'pms:service_queue_dashboard' %}" class="alert-link">AI Service Queue</a> 
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ <strong>{{ active_queue_item.get_status_display }}</strong> 
            ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
        </div>
    </div>
    {% endif %}


    <!-- Workflow Progress -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</h5>
            <div class="d-flex overflow-auto py-2 align-items-center">
                {% for step in workflow_steps %}
                    <div class="d-flex align-items-center flex-shrink-0">
                        <div class="card p-2 text-center text-nowrap {% if step == project.status %}bg-{{ theme_color|default:'primary' }} {% if theme_color == 'warning' %}text-dark{% else %}text-white{% endif %} shadow fw-bold border-{{ theme_color|default:'primary' }}{% else %}bg-white text-muted border{% endif %}" style="min-width: 80px;">
                            <div style="font-size: 0.85rem;">{{ step.label }}</div>
                        </div>
                        {% if not forloop.last %}
                            <div class="mx-1 text-muted small">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Project Info -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h5>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong></p>
                    <p class="text-muted small">{{ project.description|default:"-"|linebreaksbr }}</p>
                    <hr>
                    <p class="mb-1"><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</strong> {{ project.start_date|date:"d M Y" }}</p>
                    <p class="mb-1"><strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö:</strong> {{ project.deadline|date:"d M Y"|default:"-" }}</p>
                </div>
            </div>

            <!-- Summary -->
            <div class="card shadow-sm border-{{ theme_color|default:'primary' }}">
                <div class="card-header bg-{{ theme_color|default:'primary' }} {% if theme_color == 'warning' %}text-dark{% else %}text-white{% endif %}">
                    <h5 class="card-title mb-0">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°:</span>
                        <span class="fw-bold text-danger">&#3647;{{ project.total_cost|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°:</span>
                        <span class="fw-bold text-success">&#3647;{{ project.total_value|floatformat:2|intcomma }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">‡∏Å‡∏≥‡πÑ‡∏£:</span>
                        <span class="fw-bold text-{{ theme_color|default:'primary' }}">&#3647;{{ project.total_profit|floatformat:2|intcomma }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="card-title mb-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h5>
                    <a href="{% url 'pms:item_add' project.pk %}" class="btn btn-sm btn-{{ theme_color|default:'primary' }} shadow-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                        <i class="fas fa-plus"></i>
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                    <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th class="text-end">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                                    <th class="text-end">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                    <th class="text-end">‡∏£‡∏ß‡∏°</th>
                                    <th class="text-end">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ item.name }}</div>
                                        {% if item.supplier %}
                                        <div class="small text-muted">‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå: {{ item.supplier.name }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if item.item_type == 'PRODUCT' %}
                                        <span class="badge bg-secondary">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                                        {% else %}
                                        <span class="badge bg-info text-dark">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-end text-muted">{{ item.unit_cost|floatformat:2|intcomma }}</td>
                                    <td class="text-end">{{ item.unit_price|floatformat:2|intcomma }}</td>
                                    <td class="text-end fw-bold">{{ item.total_price|floatformat:2|intcomma }}</td>
                                    <td class="text-end">
                                        <a href="{% url 'pms:item_update' item.id %}" class="text-warning me-2">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'pms:item_delete' item.id %}" class="text-danger" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="5" class="text-end fw-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</td>
                                    <td class="text-end fw-bold text-success">&#3647;{{ project.total_value|floatformat:2|intcomma }}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function unlockClosedProject() {
    const code = prompt("üîë ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏à‡∏ö:");
    if (code === "9com") {
        window.location.href = "{% url 'pms:project_update' project.pk %}?unlock=9com";
    } else if (code !== null) {
        alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
    }
}
</script>
{% endblock %}

