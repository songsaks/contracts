{% extends 'pms/base_pms.html' %}

{% block content %}
<div class="container-fluid px-0 px-md-3">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm border-0 border-md-1">
                <div class="card-body p-3 p-md-4">
                    <h5 class="card-title mb-4 fw-bold">{{ title }}</h5>
                    
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Text Input Area -->
                        <div class="mb-4">
                            <!-- We use the form widget directly but ensure it has proper spacing -->
                            {{ form.content }}
                            {% if form.content.errors %}
                            <div class="text-danger mt-1 small">
                                {{ form.content.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Status Text -->
                        <div class="text-center mb-3 text-truncate" style="min-height: 24px;">
                            <span id="speech-status" class="text-muted small">แตะปุ่มไมโครโฟนเพื่อเริ่มพูด</span>
                        </div>

                        <!-- Large Mic Button -->
                        <div class="d-flex justify-content-center mb-5">
                            <button type="button" id="btn-mic" class="btn btn-outline-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border-width: 2px;">
                                <i class="fas fa-microphone fa-2x"></i>
                            </button>
                        </div>

                        <!-- Actions -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg py-3 rounded-pill fw-bold shadow-sm">
                                <i class="fas fa-save me-2"></i> บันทึกข้อมูล
                            </button>
                            <a href="{% url 'pms:requirement_list' %}" class="btn btn-light btn-lg rounded-pill text-muted">
                                ยกเลิก
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const btnMic = document.getElementById('btn-mic');
        const txtContent = document.getElementById('requirement-content');
        const statusText = document.getElementById('speech-status');

        if (!navigator.onLine) {
            statusText.innerHTML = '<span class="text-danger"><i class="fas fa-wifi-slash"></i> ไม่ได้เชื่อมต่ออินเทอร์เน็ต</span>';
            btnMic.disabled = true;
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.continuous = true; 
            recognition.interimResults = true;

            let isListening = false; // Intended state
            let baseContent = ""; // Content before current speech session
            let finalTranscript = ""; // Finalized speech in this session
            let restartTimer = null;

            function updateUI(recording) {
                if (recording) {
                    btnMic.classList.remove('btn-outline-primary');
                    btnMic.classList.add('btn-danger', 'pulse-animation');
                    btnMic.innerHTML = '<i class="fas fa-stop fa-2x"></i>';
                } else {
                    btnMic.classList.remove('btn-danger', 'pulse-animation');
                    btnMic.classList.add('btn-outline-primary');
                    btnMic.innerHTML = '<i class="fas fa-microphone fa-2x"></i>';
                }
            }

            btnMic.addEventListener('click', function() {
                if (isListening) {
                    // User wants to STOP
                    isListening = false;
                    recognition.stop();
                    // Clear restart timer if exists
                    if (restartTimer) clearTimeout(restartTimer);
                    statusText.innerText = "กำลังจบบันทึก...";
                } else {
                    // User wants to START
                    isListening = true;
                    // Capture current text to append to
                    baseContent = txtContent.value;
                    if (baseContent && !/\s$/.test(baseContent)) {
                       baseContent += ' ';
                    }
                    finalTranscript = ""; // Reset session text
                    
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("Start error:", e);
                    }
                }
            });

            // --- Status Events ---

            recognition.onstart = function() {
                updateUI(true);
                statusText.innerText = "กำลังรับฟัง... (พูดได้เลย)";
                statusText.className = 'text-primary fw-bold small';
            };

            recognition.onend = function() {
                updateUI(false);
                if (isListening) {
                    // Auto-restart if Intended State is Listening (Continuous Mode)
                    // First, sync baseContent with what we have
                    baseContent = txtContent.value;
                    if (baseContent && !/\s$/.test(baseContent)) {
                       baseContent += ' ';
                    }
                    finalTranscript = "";
                    
                    statusText.innerText = "กำลังเชื่อมต่อไมโครโฟนใหม่...";
                    
                    // Restart logic
                    restartTimer = setTimeout(() => {
                        try {
                            if (isListening) recognition.start();
                        } catch(e) { console.log("Restart ignore", e); }
                    }, 300);
                } else {
                    statusText.innerText = "แตะปุ่มไมโครโฟนเพื่อเริ่มพูด";
                    statusText.className = 'text-muted small';
                }
            };

            recognition.onerror = function(event) {
                console.error("Speech Error:", event.error);
                let msg = "Error: " + event.error;
                
                if (event.error === 'no-speech') {
                    // Ignore no-speech errors in continuous mode
                    return; 
                } 
                if (event.error === 'not-allowed') {
                    msg = "ถูกปฏิเสธการเข้าถึงไมโครโฟน";
                    isListening = false; // Fatal
                } else if (event.error === 'network') {
                    msg = "ปัญหาอินเทอร์เน็ต";
                    isListening = false; // Fatal
                }

                statusText.innerText = msg;
                statusText.className = 'text-danger fw-bold small';
                
                if (!isListening) {
                    updateUI(false);
                }
            };

            // --- Result Handling ---
            
            recognition.onresult = function(event) {
                // Clear status occasionally
                statusText.innerText = "กำลังรับฟัง...";

                let interimTranscript = '';
                
                // Use resultIndex to only process new parts if possible
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                // Render: Previous Existing Text + Finalized Session Text + Interim Text
                txtContent.value = baseContent + finalTranscript + interimTranscript;
                txtContent.scrollTop = txtContent.scrollHeight;
            };
            
        } else {
            btnMic.disabled = true;
            statusText.innerText = "Browser ไม่รองรับ Web Speech API";
            statusText.className = 'text-danger small';
        }
    });
</script>

<style>
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
    .pulse-animation {
        animation: pulse 1.5s infinite;
    }
    textarea#requirement-content {
        font-size: 1.1rem;
        border-radius: 12px;
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    textarea#requirement-content:focus {
        background-color: #fff;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        border-color: #86b7fe;
    }
</style>
{% endblock %}
