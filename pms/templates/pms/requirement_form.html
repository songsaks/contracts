{% extends 'pms/base_pms.html' %}

{% block extra_css %}
<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.5);
    }

    .premium-form-container {
        padding-top: 1rem;
        padding-bottom: 2rem;
    }

    .form-card {
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .form-card .card-header {
        background: linear-gradient(145deg, #4f46e5, #7c3aed);
        color: white;
        padding: 1.25rem 1.5rem;
        border: none;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-card .card-header h5 {
        font-weight: 800;
        font-size: 1.1rem;
        margin-bottom: 0;
        letter-spacing: -0.02em;
    }

    .form-card .card-header i {
        font-size: 1.25rem;
        opacity: 0.9;
    }

    .content-box-wrapper {
        position: relative;
        margin-bottom: 1rem;
    }

    textarea#requirement-content {
        font-size: 1rem;
        border-radius: 18px;
        padding: 1rem;
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        min-height: 80px; /* Decreased size as requested */
        resize: none;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        line-height: 1.6;
    }

    textarea#requirement-content:focus {
        background-color: #fff;
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        border-color: var(--primary-color);
        outline: none;
    }

    /* Floating Mic Button */
    .mic-control-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 1.5rem 0;
    }

    .mic-btn-premium {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: white;
        border: 1px solid #e2e8f0;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        position: relative;
    }

    .mic-btn-premium::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid var(--primary-color);
        opacity: 0.2;
        transition: all 0.4s;
    }

    .mic-btn-premium:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.15);
        border-color: var(--primary-color);
    }

    .mic-btn-premium.active {
        background: #ef4444;
        border-color: #ef4444;
        color: white;
        transform: scale(1.1);
    }

    .mic-btn-premium.active::after {
        animation: pulse-ring 1.5s infinite;
        border-color: #ef4444;
        opacity: 0.5;
    }

    @keyframes pulse-ring {
        0% { transform: scale(0.95); opacity: 0.5; }
        70% { transform: scale(1.4); opacity: 0; }
        100% { transform: scale(1.4); opacity: 0; }
    }

    #speech-status {
        font-weight: 600;
        font-size: 0.8rem;
        margin-top: 0.75rem;
        transition: color 0.3s;
    }

    /* Section Label */
    .section-label {
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #64748b;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Premium upload zone */
    .file-upload-zone-premium {
        background: rgba(248, 250, 252, 0.5);
        border: 2px dashed #cbd5e1;
        border-radius: 20px;
        padding: 1.75rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .file-upload-zone-premium:hover {
        background: #ffffff;
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    .upload-icon-box {
        width: 48px;
        height: 48px;
        background: white;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
        color: #94a3b8;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }

    .file-upload-zone-premium:hover .upload-icon-box {
        color: var(--primary-color);
        transform: scale(1.1);
    }

    /* Submit Button Premium */
    .btn-submit-premium {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        border: none;
        border-radius: 18px;
        padding: 1rem;
        font-weight: 700;
        font-size: 1rem;
        box-shadow: 0 8px 20px rgba(79, 70, 229, 0.25);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-submit-premium:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(79, 70, 229, 0.35);
        filter: brightness(1.05);
    }

    .btn-submit-premium:active {
        transform: translateY(0);
    }

    .file-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }

    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .form-card {
            border-radius: 0;
            border-left: none;
            border-right: none;
            margin: -0.5rem -0.75rem;
        }

        .premium-form-container {
            padding-top: 0.5rem;
        }

        textarea#requirement-content {
            min-height: 70px;
            font-size: 0.95rem;
        }

        .mic-btn-premium {
            width: 60px;
            height: 60px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="premium-form-container">
    <div class="row justify-content-center">
        <div class="col-md-9 col-lg-7">
            <div class="card form-card">
                <div class="card-header">
                    <i class="fas fa-microphone-lines"></i>
                    <h5 class="mb-0">{{ title }}</h5>
                </div>
                
                <div class="card-body p-4 p-md-5">
                    <form method="post" enctype="multipart/form-data" id="requirementForm">
                        {% csrf_token %}
                        
                        <!-- Content Area -->
                        <div class="mb-2">
                            <label class="section-label">
                                <i class="fas fa-pen-nib"></i>พูดหรือพิมพ์รายละเอียด
                            </label>
                            <div class="content-box-wrapper">
                                {{ form.content }}
                            </div>
                            {% if form.content.errors %}
                            <div class="text-danger mt-1 small">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.content.errors|first }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Voice Control Center -->
                        <div class="mic-control-area">
                            <button type="button" id="btn-mic" class="mic-btn-premium" title="คลิกเพื่อพูด">
                                <i class="fas fa-microphone fa-xl"></i>
                            </button>
                            <span id="speech-status" class="text-muted">แตะปุ่มไมโครโฟนเพื่อเริ่มพูด</span>
                        </div>

                        <!-- Attachment System -->
                        <div class="mb-5">
                            <label class="section-label">
                                <i class="fas fa-images"></i>รูปภาพและไฟล์แนบ
                            </label>

                            <!-- Drop Zone Premium -->
                            <div class="file-upload-zone-premium" id="dropZone">
                                <div class="upload-icon-box">
                                    <i class="fas fa-plus fa-lg"></i>
                                </div>
                                <div class="fw-bold text-dark small">เพิ่มรูปภาพหรือไฟล์</div>
                                <div class="text-muted" style="font-size: 0.75rem; margin-top: 2px;">
                                    หรือลากไฟล์มาวางที่นี่ (ไม่เกิน 10 ไฟล์)
                                </div>
                                <input type="file" name="attachments" id="fileInput" 
                                       multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                                       style="display: none;">
                            </div>

                            <!-- Preview Grid -->
                            <div class="file-preview-grid" id="filePreviewGrid"></div>

                            {% if existing_files %}
                            <!-- Manage Existing -->
                            <div class="mt-4">
                                <label class="section-label">
                                    <i class="fas fa-layer-group"></i>ไฟล์ปัจจุบัน ({{ existing_files|length }})
                                </label>
                                {% for pf in existing_files %}
                                <div class="existing-file-item">
                                    {% if pf.is_image %}
                                        <img src="{{ pf.file.url }}" alt="{{ pf.original_name }}" class="file-thumb">
                                    {% else %}
                                        <div class="file-icon-box">
                                            <i class="fas fa-file-lines"></i>
                                        </div>
                                    {% endif %}
                                    <div class="file-info">
                                        <div class="name">{{ pf.original_name }}</div>
                                        <div class="meta">{{ pf.file_size_display }}</div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="{{ pf.file.url }}" class="btn btn-sm btn-outline-secondary border-0" download>
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <a href="{% url 'pms:requirement_file_delete' pf.pk %}" 
                                           class="btn btn-sm btn-outline-danger border-0" 
                                           onclick="return confirm('ลบไฟล์นี้หรือไม่?')">
                                            <i class="fas fa-trash-can"></i>
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Action Bar -->
                        <div class="d-grid gap-3 pt-2">
                            <button type="submit" class="btn btn-submit-premium">
                                <i class="fas fa-check-double me-2"></i>บันทึกข้อมูล
                            </button>
                            <a href="{% url 'pms:requirement_list' %}" class="btn btn-light rounded-pill text-muted fw-bold" style="font-size: 0.9rem;">
                                ยกเลิกและกลับ
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ===== File Upload Logic =====
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewGrid = document.getElementById('filePreviewGrid');
        let selectedFiles = [];

        // Click to open file picker
        dropZone.addEventListener('click', function() {
            fileInput.click();
        });

        // Drag & drop
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', function() {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', function() {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            for (let i = 0; i < files.length && selectedFiles.length < 10; i++) {
                selectedFiles.push(files[i]);
            }
            updatePreview();
            updateFileInput();
        }

        function updatePreview() {
            previewGrid.innerHTML = '';
            selectedFiles.forEach(function(file, index) {
                const item = document.createElement('div');
                item.className = 'file-preview-item';

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    item.appendChild(img);
                } else {
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'file-icon-placeholder';
                    let iconClass = 'fa-file';
                    if (file.name.endsWith('.pdf')) iconClass = 'fa-file-pdf';
                    else if (file.name.match(/\.(doc|docx)$/)) iconClass = 'fa-file-word';
                    else if (file.name.match(/\.(xls|xlsx)$/)) iconClass = 'fa-file-excel';
                    iconDiv.innerHTML = '<i class="fas ' + iconClass + '"></i>';
                    item.appendChild(iconDiv);
                }

                const nameDiv = document.createElement('div');
                nameDiv.className = 'file-name';
                nameDiv.textContent = file.name;
                item.appendChild(nameDiv);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectedFiles.splice(index, 1);
                    updatePreview();
                    updateFileInput();
                });
                item.appendChild(removeBtn);

                previewGrid.appendChild(item);
            });
        }

        function updateFileInput() {
            // Create a new DataTransfer to update the file input
            const dt = new DataTransfer();
            selectedFiles.forEach(function(file) {
                dt.items.add(file);
            });
            fileInput.files = dt.files;
        }


        // ===== Speech Recognition =====
        const btnMic = document.getElementById('btn-mic');
        const txtContent = document.getElementById('requirement-content');
        const statusText = document.getElementById('speech-status');

        if (!navigator.onLine) {
            statusText.innerHTML = '<span class="text-danger"><i class="fas fa-wifi-slash"></i> ไม่ได้เชื่อมต่ออินเทอร์เน็ต</span>';
            btnMic.disabled = true;
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.continuous = false; 
            recognition.interimResults = true;

            let isRecording = false;
            let originalValue = "";

            function setRecordingState(recording) {
                isRecording = recording;
                if (recording) {
                    btnMic.classList.add('active');
                    btnMic.innerHTML = '<i class="fas fa-stop fa-xl"></i>';
                } else {
                    btnMic.classList.remove('active');
                    btnMic.innerHTML = '<i class="fas fa-microphone fa-xl"></i>';
                }
            }

            btnMic.addEventListener('click', function() {
                if (isRecording) {
                    recognition.stop();
                } else {
                    originalValue = txtContent.value;
                    if (originalValue && !/\s$/.test(originalValue)) {
                       originalValue += ' ';
                    }
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Recognition error:', e);
                        statusText.innerText = "Error: " + e.message;
                    }
                }
            });

            recognition.onstart = function() {
                setRecordingState(true);
                statusText.innerText = "กำลังรับฟัง... พูดได้เลย";
                statusText.style.color = "var(--primary-color)";
            };

            recognition.onend = function() {
                setRecordingState(false);
                statusText.innerText = "แตะปุ่มไมโครโฟนเพื่อเริ่มพูด";
                statusText.style.color = "";
            };

            recognition.onerror = function(event) {
                let msg = "Error: " + event.error;
                if (event.error === 'no-speech') msg = "ไม่ได้รับเสียง (แตะใหม่)";
                else if (event.error === 'not-allowed') msg = "เข้าถึงไมค์ไม่ได้";
                
                statusText.innerText = msg;
                statusText.style.color = "#ef4444";
                setRecordingState(false);
            };

            recognition.onresult = function(event) {
                let transcript = '';
                if (event.results.length > 0) {
                    transcript = event.results[event.results.length - 1][0].transcript;
                }
                txtContent.value = originalValue + transcript;
                txtContent.scrollTop = txtContent.scrollHeight;
            };
            
        } else {
            btnMic.disabled = true;
            statusText.innerText = "Browser ไม่รองรับ Web Speech API";
            statusText.className = 'text-danger small';
        }
    });
</script>
{% endblock %}
