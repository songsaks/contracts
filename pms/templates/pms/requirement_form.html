{% extends 'pms/base_pms.html' %}

{% block extra_css %}
<style>
    .form-card {
        border: none;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .form-card .card-header {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: white;
        padding: 1rem 1.5rem;
    }

    .form-card .card-header h5 {
        font-weight: 700;
        font-size: 1rem;
    }

    .mic-btn {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        border: 2px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
    }

    .mic-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    .mic-btn.btn-danger {
        border-color: var(--danger-color, #dc3545);
        background: var(--danger-color, #dc3545);
        color: white;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }

    .pulse-animation {
        animation: pulse 1.5s infinite;
    }

    textarea#requirement-content {
        font-size: 1rem;
        border-radius: var(--radius-md);
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid var(--border-color);
        min-height: 120px;
    }

    textarea#requirement-content:focus {
        background-color: #fff;
        box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.12);
        border-color: var(--primary-color);
    }

    @media (max-width: 767.98px) {
        .form-card .card-body {
            padding: 1.25rem;
        }

        .mic-btn {
            width: 64px;
            height: 64px;
        }

        textarea#requirement-content {
            font-size: 0.95rem;
            min-height: 100px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0 px-md-3">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card form-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-microphone-alt me-2"></i>
                        {{ title }}
                    </h5>
                </div>
                <div class="card-body p-3 p-md-4">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Text Input Area -->
                        <div class="mb-3">
                            {{ form.content }}
                            {% if form.content.errors %}
                            <div class="text-danger mt-1 small">
                                {{ form.content.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Status Text -->
                        <div class="text-center mb-3 text-truncate" style="min-height: 24px;">
                            <span id="speech-status" class="text-muted small">แตะปุ่มไมโครโฟนเพื่อเริ่มพูด</span>
                        </div>

                        <!-- Large Mic Button -->
                        <div class="d-flex justify-content-center mb-4">
                            <button type="button" id="btn-mic" class="mic-btn">
                                <i class="fas fa-microphone fa-2x"></i>
                            </button>
                        </div>

                        <!-- Actions -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg py-3 rounded-pill fw-bold shadow-sm">
                                <i class="fas fa-save me-2"></i> บันทึกข้อมูล
                            </button>
                            <a href="{% url 'pms:requirement_list' %}" class="btn btn-light btn-lg rounded-pill text-muted">
                                ยกเลิก
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const btnMic = document.getElementById('btn-mic');
        const txtContent = document.getElementById('requirement-content');
        const statusText = document.getElementById('speech-status');

        if (!navigator.onLine) {
            statusText.innerHTML = '<span class="text-danger"><i class="fas fa-wifi-slash"></i> ไม่ได้เชื่อมต่ออินเทอร์เน็ต</span>';
            btnMic.disabled = true;
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.continuous = false; 
            recognition.interimResults = true;

            let isRecording = false;
            let originalValue = "";

            function setRecordingState(recording) {
                isRecording = recording;
                if (recording) {
                    btnMic.classList.remove('btn-outline-primary');
                    btnMic.classList.add('btn-danger', 'pulse-animation');
                    btnMic.innerHTML = '<i class="fas fa-stop fa-2x"></i>';
                } else {
                    btnMic.classList.remove('btn-danger', 'pulse-animation');
                    btnMic.classList.add('btn-outline-primary');
                    btnMic.innerHTML = '<i class="fas fa-microphone fa-2x"></i>';
                }
            }

            btnMic.addEventListener('click', function() {
                if (isRecording) {
                    recognition.stop();
                } else {
                    originalValue = txtContent.value;
                    if (originalValue && !/\s$/.test(originalValue)) {
                       originalValue += ' ';
                    }
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Error starting recognition:', e);
                        statusText.innerText = "Error: " + e.message;
                    }
                }
            });

            recognition.onstart = function() {
                setRecordingState(true);
                statusText.innerText = "กำลังรับฟัง... (พูดได้เลย)";
                statusText.className = 'text-primary fw-bold small';
            };

            recognition.onaudiostart = function() {
                statusText.innerText = "ตรวจพบสัญญาณเสียง... กำลังรับฟัง";
            };

            recognition.onend = function() {
                setRecordingState(false);
                statusText.innerText = "แตะปุ่มไมโครโฟนเพื่อเริ่มพูด";
                statusText.className = 'text-muted small';
            };

            recognition.onerror = function(event) {
                console.error("Speech Error:", event.error);
                let msg = "Error: " + event.error;
                
                if (event.error === 'network') {
                    msg = "ปัญหาการเชื่อมต่อเครือข่าย";
                } else if (event.error === 'not-allowed') {
                    msg = "ถูกปฏิเสธการเข้าถึงไมโครโฟน";
                } else if (event.error === 'no-speech') {
                    msg = "ไม่ได้รับเสียงพูด (ลองใหม่)";
                }

                statusText.innerText = msg;
                statusText.className = 'text-danger fw-bold small';
                setRecordingState(false);
            };

            recognition.onresult = function(event) {
                statusText.innerText = "กำลังแปลงข้อความ...";
                
                let transcript = '';
                if (event.results.length > 0) {
                    const len = event.results.length;
                    const result = event.results[len - 1];
                    transcript = result[0].transcript;
                }

                txtContent.value = originalValue + transcript;
                txtContent.scrollTop = txtContent.scrollHeight;
            };
            
        } else {
            btnMic.disabled = true;
            statusText.innerText = "Browser ไม่รองรับ Web Speech API";
            statusText.className = 'text-danger small';
        }
    });
</script>
{% endblock %}
