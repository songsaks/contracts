{% extends 'pms/base_pms.html' %}

{% block extra_css %}
<style>
    .form-card {
        border: none;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .form-card .card-header {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: white;
        padding: 1rem 1.5rem;
    }

    .form-card .card-header h5 {
        font-weight: 700;
        font-size: 1rem;
    }

    .mic-btn {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        border: 2px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
    }

    .mic-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    .mic-btn.btn-danger {
        border-color: var(--danger-color, #dc3545);
        background: var(--danger-color, #dc3545);
        color: white;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }

    .pulse-animation {
        animation: pulse 1.5s infinite;
    }

    textarea#requirement-content {
        font-size: 1rem;
        border-radius: var(--radius-md);
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid var(--border-color);
        min-height: 120px;
    }

    textarea#requirement-content:focus {
        background-color: #fff;
        box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.12);
        border-color: var(--primary-color);
    }

    /* ===== File Upload Styles ===== */
    .file-upload-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8fafc;
        position: relative;
    }

    .file-upload-zone:hover,
    .file-upload-zone.drag-over {
        border-color: var(--primary-color, #4f46e5);
        background: rgba(79, 70, 229, 0.04);
    }

    .file-upload-zone .upload-icon {
        font-size: 2rem;
        color: #94a3b8;
        margin-bottom: 0.5rem;
    }

    .file-upload-zone.drag-over .upload-icon {
        color: var(--primary-color, #4f46e5);
        transform: scale(1.1);
    }

    .file-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .file-preview-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        transition: transform 0.2s;
    }

    .file-preview-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .file-preview-item img {
        width: 100%;
        height: 80px;
        object-fit: cover;
    }

    .file-preview-item .file-icon-placeholder {
        width: 100%;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
        font-size: 1.5rem;
        color: #64748b;
    }

    .file-preview-item .file-name {
        font-size: 0.65rem;
        padding: 4px 6px;
        color: #475569;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .file-preview-item .remove-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.6rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .file-preview-item:hover .remove-btn {
        opacity: 1;
    }

    /* Existing files (already saved) */
    .existing-file-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: white;
        transition: all 0.2s;
    }

    .existing-file-item:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }

    .existing-file-item .file-thumb {
        width: 44px;
        height: 44px;
        border-radius: 6px;
        object-fit: cover;
        flex-shrink: 0;
    }

    .existing-file-item .file-icon-box {
        width: 44px;
        height: 44px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f1f5f9;
        color: #64748b;
        flex-shrink: 0;
    }

    .existing-file-item .file-info {
        flex-grow: 1;
        min-width: 0;
    }

    .existing-file-item .file-info .name {
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .existing-file-item .file-info .meta {
        font-size: 0.7rem;
        color: #94a3b8;
    }

    @media (max-width: 767.98px) {
        .form-card .card-body {
            padding: 1.25rem;
        }

        .mic-btn {
            width: 64px;
            height: 64px;
        }

        textarea#requirement-content {
            font-size: 0.95rem;
            min-height: 100px;
        }

        .file-preview-grid {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0 px-md-3">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card form-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-microphone-alt me-2"></i>
                        {{ title }}
                    </h5>
                </div>
                <div class="card-body p-3 p-md-4">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Text Input Area -->
                        <div class="mb-3">
                            {{ form.content }}
                            {% if form.content.errors %}
                            <div class="text-danger mt-1 small">
                                {{ form.content.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Status Text -->
                        <div class="text-center mb-3 text-truncate" style="min-height: 24px;">
                            <span id="speech-status" class="text-muted small">แตะปุ่มไมโครโฟนเพื่อเริ่มพูด</span>
                        </div>

                        <!-- Large Mic Button -->
                        <div class="d-flex justify-content-center mb-4">
                            <button type="button" id="btn-mic" class="mic-btn">
                                <i class="fas fa-microphone fa-2x"></i>
                            </button>
                        </div>

                        <!-- File Upload Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold text-muted small text-uppercase">
                                <i class="fas fa-paperclip me-1"></i>แนบไฟล์/รูปภาพ
                            </label>

                            <!-- Drop Zone -->
                            <div class="file-upload-zone" id="dropZone">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="fw-bold text-muted small">
                                    แตะเพื่อเลือกไฟล์ หรือลากไฟล์มาวาง
                                </div>
                                <div class="text-muted small mt-1">
                                    รองรับ: ภาพ, PDF, เอกสาร (สูงสุด 10 ไฟล์)
                                </div>
                                <input type="file" name="attachments" id="fileInput" 
                                       multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                                       style="display: none;">
                            </div>

                            <!-- New File Previews -->
                            <div class="file-preview-grid" id="filePreviewGrid"></div>

                            {% if existing_files %}
                            <!-- Existing Files (edit mode) -->
                            <div class="mt-3">
                                <label class="form-label fw-bold text-muted small text-uppercase mb-2">
                                    <i class="fas fa-folder-open me-1"></i>ไฟล์ที่แนบไว้แล้ว ({{ existing_files|length }})
                                </label>
                                {% for pf in existing_files %}
                                <div class="existing-file-item">
                                    {% if pf.is_image %}
                                        <img src="{{ pf.file.url }}" alt="{{ pf.original_name }}" class="file-thumb">
                                    {% else %}
                                        <div class="file-icon-box">
                                            <i class="fas fa-file fa-lg"></i>
                                        </div>
                                    {% endif %}
                                    <div class="file-info">
                                        <div class="name">{{ pf.original_name }}</div>
                                        <div class="meta">{{ pf.file_size_display }} · {{ pf.uploaded_at|date:"d/m/Y H:i" }}</div>
                                    </div>
                                    <a href="{{ pf.file.url }}" class="btn btn-sm btn-outline-primary" download title="ดาวน์โหลด">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <a href="{% url 'pms:requirement_file_delete' pf.pk %}" 
                                       class="btn btn-sm btn-outline-danger" 
                                       onclick="return confirm('ยืนยันการลบไฟล์นี้?')"
                                       title="ลบ">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Actions -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg py-3 rounded-pill fw-bold shadow-sm">
                                <i class="fas fa-save me-2"></i> บันทึกข้อมูล
                            </button>
                            <a href="{% url 'pms:requirement_list' %}" class="btn btn-light btn-lg rounded-pill text-muted">
                                ยกเลิก
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ===== File Upload Logic =====
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewGrid = document.getElementById('filePreviewGrid');
        let selectedFiles = [];

        // Click to open file picker
        dropZone.addEventListener('click', function() {
            fileInput.click();
        });

        // Drag & drop
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', function() {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', function() {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            for (let i = 0; i < files.length && selectedFiles.length < 10; i++) {
                selectedFiles.push(files[i]);
            }
            updatePreview();
            updateFileInput();
        }

        function updatePreview() {
            previewGrid.innerHTML = '';
            selectedFiles.forEach(function(file, index) {
                const item = document.createElement('div');
                item.className = 'file-preview-item';

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    item.appendChild(img);
                } else {
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'file-icon-placeholder';
                    let iconClass = 'fa-file';
                    if (file.name.endsWith('.pdf')) iconClass = 'fa-file-pdf';
                    else if (file.name.match(/\.(doc|docx)$/)) iconClass = 'fa-file-word';
                    else if (file.name.match(/\.(xls|xlsx)$/)) iconClass = 'fa-file-excel';
                    iconDiv.innerHTML = '<i class="fas ' + iconClass + '"></i>';
                    item.appendChild(iconDiv);
                }

                const nameDiv = document.createElement('div');
                nameDiv.className = 'file-name';
                nameDiv.textContent = file.name;
                item.appendChild(nameDiv);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectedFiles.splice(index, 1);
                    updatePreview();
                    updateFileInput();
                });
                item.appendChild(removeBtn);

                previewGrid.appendChild(item);
            });
        }

        function updateFileInput() {
            // Create a new DataTransfer to update the file input
            const dt = new DataTransfer();
            selectedFiles.forEach(function(file) {
                dt.items.add(file);
            });
            fileInput.files = dt.files;
        }


        // ===== Speech Recognition =====
        const btnMic = document.getElementById('btn-mic');
        const txtContent = document.getElementById('requirement-content');
        const statusText = document.getElementById('speech-status');

        if (!navigator.onLine) {
            statusText.innerHTML = '<span class="text-danger"><i class="fas fa-wifi-slash"></i> ไม่ได้เชื่อมต่ออินเทอร์เน็ต</span>';
            btnMic.disabled = true;
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.continuous = false; 
            recognition.interimResults = true;

            let isRecording = false;
            let originalValue = "";

            function setRecordingState(recording) {
                isRecording = recording;
                if (recording) {
                    btnMic.classList.remove('btn-outline-primary');
                    btnMic.classList.add('btn-danger', 'pulse-animation');
                    btnMic.innerHTML = '<i class="fas fa-stop fa-2x"></i>';
                } else {
                    btnMic.classList.remove('btn-danger', 'pulse-animation');
                    btnMic.classList.add('btn-outline-primary');
                    btnMic.innerHTML = '<i class="fas fa-microphone fa-2x"></i>';
                }
            }

            btnMic.addEventListener('click', function() {
                if (isRecording) {
                    recognition.stop();
                } else {
                    originalValue = txtContent.value;
                    if (originalValue && !/\s$/.test(originalValue)) {
                       originalValue += ' ';
                    }
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Error starting recognition:', e);
                        statusText.innerText = "Error: " + e.message;
                    }
                }
            });

            recognition.onstart = function() {
                setRecordingState(true);
                statusText.innerText = "กำลังรับฟัง... (พูดได้เลย)";
                statusText.className = 'text-primary fw-bold small';
            };

            recognition.onaudiostart = function() {
                statusText.innerText = "ตรวจพบสัญญาณเสียง... กำลังรับฟัง";
            };

            recognition.onend = function() {
                setRecordingState(false);
                statusText.innerText = "แตะปุ่มไมโครโฟนเพื่อเริ่มพูด";
                statusText.className = 'text-muted small';
            };

            recognition.onerror = function(event) {
                console.error("Speech Error:", event.error);
                let msg = "Error: " + event.error;
                
                if (event.error === 'network') {
                    msg = "ปัญหาการเชื่อมต่อเครือข่าย";
                } else if (event.error === 'not-allowed') {
                    msg = "ถูกปฏิเสธการเข้าถึงไมโครโฟน";
                } else if (event.error === 'no-speech') {
                    msg = "ไม่ได้รับเสียงพูด (ลองใหม่)";
                }

                statusText.innerText = msg;
                statusText.className = 'text-danger fw-bold small';
                setRecordingState(false);
            };

            recognition.onresult = function(event) {
                statusText.innerText = "กำลังแปลงข้อความ...";
                
                let transcript = '';
                if (event.results.length > 0) {
                    const len = event.results.length;
                    const result = event.results[len - 1];
                    transcript = result[0].transcript;
                }

                txtContent.value = originalValue + transcript;
                txtContent.scrollTop = txtContent.scrollHeight;
            };
            
        } else {
            btnMic.disabled = true;
            statusText.innerText = "Browser ไม่รองรับ Web Speech API";
            statusText.className = 'text-danger small';
        }
    });
</script>
{% endblock %}
