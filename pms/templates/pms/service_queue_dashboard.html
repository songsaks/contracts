{% extends 'pms/base_pms.html' %}
{% load humanize %}

{% block title %}AI Service Queue{% endblock %}

{% block extra_css %}
<style>
    .queue-header {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        border-radius: var(--radius-lg);
        padding: 1.25rem 1.5rem;
        color: white;
        margin-bottom: 1.5rem;
    }

    .queue-header h2 {
        font-size: 1.25rem;
        font-weight: 700;
    }

    .queue-stat-card {
        background: white;
        border-radius: var(--radius-md);
        padding: 1rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        text-align: center;
        transition: transform 0.2s;
    }
    .queue-stat-card:hover { transform: translateY(-2px); }
    .queue-stat-number { font-size: 1.75rem; font-weight: 800; line-height: 1.2; }

    .section-header {
        border-radius: var(--radius-md) var(--radius-md) 0 0;
        padding: 0.75rem 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .badge-repair { background: #fff7ed; color: #c2410c; }
    .badge-delivery { background: #f0fdf4; color: #15803d; }
    .badge-install { background: #eff6ff; color: #1d4ed8; }
    .badge-other { background: #f9fafb; color: #6b7280; }

    .team-pill {
        display: inline-flex; align-items: center; gap: 4px;
        padding: 3px 10px; border-radius: 20px; font-size: 0.75rem;
        background: #f1f5f9; border: 1px solid #e2e8f0;
    }

    .date-block { margin-bottom: 1.25rem; }
    .date-block-header {
        background: linear-gradient(135deg, #059669, #10b981);
        color: white; padding: 0.625rem 1rem;
        border-radius: var(--radius-md) var(--radius-md) 0 0;
        font-weight: 600; font-size: 0.85rem;
        display: flex; justify-content: space-between; align-items: center;
    }
    .date-block-today { background: linear-gradient(135deg, #2563eb, #3b82f6); }
    .date-block-past { background: linear-gradient(135deg, #dc2626, #ef4444); }

    .pulse-dot { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* Mobile Task Card */
    .task-card-mobile {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.875rem;
        margin-bottom: 0.625rem;
        background: white;
    }

    .task-card-mobile .task-title {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .task-card-mobile .task-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Responsive */
    @media (max-width: 767.98px) {
        .queue-header {
            padding: 1rem;
            border-radius: var(--radius-md);
        }

        .queue-header h2 {
            font-size: 1.1rem;
        }

        .queue-header p {
            font-size: 0.8rem;
        }

        .queue-stat-number {
            font-size: 1.35rem;
        }

        .queue-stat-card {
            padding: 0.75rem;
        }

        .queue-stat-card .text-muted {
            font-size: 0.65rem;
        }

        .queue-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }

        .queue-action-buttons .btn {
            font-size: 0.8rem;
            padding: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="queue-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <h2 class="mb-1"><i class="fas fa-robot me-2"></i>AI Service Queue</h2>
            <p class="mb-0 opacity-75" style="font-size: 0.85rem;"><i class="fas fa-calendar-day me-1"></i> {{ today|date:"l, d F Y" }}</p>
        </div>
        <div class="d-none d-md-flex gap-2 flex-wrap">
            <form action="{% url 'pms:auto_schedule_tasks' %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('ü§ñ ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏ó‡∏µ‡∏°+‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß?')"
                    class="btn btn-warning fw-semibold px-3">
                    <i class="fas fa-magic me-1"></i> ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß+AI
                </button>
            </form>
            <a href="{% url 'pms:team_list' %}" class="btn btn-outline-light px-3">
                <i class="fas fa-users-cog me-1"></i> ‡∏ó‡∏µ‡∏°
            </a>
            <a href="{% url 'pms:team_messages' %}" class="btn btn-outline-light px-3">
                <i class="fas fa-envelope me-1"></i> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            </a>
        </div>
    </div>
    <!-- Mobile Action Buttons -->
    <div class="d-md-none mt-3 queue-action-buttons">
        <div class="d-flex gap-2">
            <form action="{% url 'pms:auto_schedule_tasks' %}" method="post" class="flex-fill">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('ü§ñ ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô?')" class="btn btn-warning fw-semibold w-100">
                    <i class="fas fa-magic me-1"></i> ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß+AI
                </button>
            </form>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'pms:team_list' %}" class="btn btn-outline-light flex-fill" style="font-size: 0.8rem;">
                <i class="fas fa-users-cog me-1"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°
            </a>
            <a href="{% url 'pms:team_messages' %}" class="btn btn-outline-light flex-fill" style="font-size: 0.8rem;">
                <i class="fas fa-envelope me-1"></i> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            </a>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="row g-2 g-md-3 mb-4">
    <div class="col-4">
        <div class="queue-stat-card">
            <div class="queue-stat-number text-warning">{{ pending_count }}</div>
            <div class="text-muted small"><i class="fas fa-clock me-1"></i>‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</div>
        </div>
    </div>
    <div class="col-4">
        <div class="queue-stat-card">
            <div class="queue-stat-number text-primary">{{ scheduled_count }}</div>
            <div class="text-muted small"><i class="fas fa-calendar-check me-1"></i>‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</div>
        </div>
    </div>
    <div class="col-4">
        <div class="queue-stat-card">
            <div class="queue-stat-number text-success">{{ completed_count }}</div>
            <div class="text-muted small"><i class="fas fa-check-circle me-1"></i>‡πÄ‡∏™‡∏£‡πá‡∏à</div>
        </div>
    </div>
</div>

<!-- ============ BLOCK 1: Pending Tasks ============ -->
<div class="card border-0 shadow-sm mb-4">
    <div class="section-header text-white" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <span><i class="fas fa-inbox me-2"></i>‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</span>
        <span class="badge bg-white text-warning">{{ pending_count }} ‡∏á‡∏≤‡∏ô</span>
    </div>

    {% if pending_tasks %}
    <!-- Desktop Table -->
    <div class="table-responsive d-none d-md-block">
        <table class="table table-hover mb-0 align-middle">
            <thead class="bg-light">
                <tr class="small text-uppercase text-muted">
                    <th class="px-3 py-2">‡∏á‡∏≤‡∏ô</th>
                    <th class="px-3 py-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th class="px-3 py-2">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                    <th class="px-3 py-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
                    <th class="px-3 py-2" style="min-width:160px;">‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô (AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</th>
                    <th class="px-3 py-2" style="min-width:150px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                    <th class="px-3 py-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                </tr>
            </thead>
            <tbody>
                {% for task in pending_tasks %}
                <tr>
                    <td class="px-3 py-3">
                        <div class="fw-semibold">{{ task.title }}</div>
                        {% if task.description %}<div class="small text-muted">{{ task.description|truncatechars:50 }}</div>{% endif %}
                        {% if task.completion_note %}<div class="small text-danger fw-bold mt-1"><i class="fas fa-exclamation-triangle mt-1 me-1"></i>‡∏¢‡∏Å‡∏¢‡∏≠‡∏î: {{ task.completion_note|truncatechars:100 }}</div>{% endif %}
                        {% if task.project %}
                        <a href="{% url 'pms:project_detail' task.project.pk %}" class="badge bg-info text-decoration-none mt-1">
                            <i class="fas fa-link me-1"></i>{{ task.project.name|truncatechars:25 }}
                        </a>
                        {% endif %}
                    </td>
                    <td class="px-3 py-3">
                        {% if task.task_type == 'REPAIR' %}<span class="badge badge-repair"><i class="fas fa-wrench me-1"></i>‡∏ã‡πà‡∏≠‡∏°</span>
                        {% elif task.task_type == 'DELIVERY' %}<span class="badge badge-delivery"><i class="fas fa-truck me-1"></i>‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</span>
                        {% elif task.task_type == 'INSTALLATION' %}<span class="badge badge-install"><i class="fas fa-tools me-1"></i>‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</span>
                        {% else %}<span class="badge badge-other"><i class="fas fa-list me-1"></i>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>{% endif %}
                    </td>
                    <td class="px-3 py-3 small">
                        {% if task.project %}{{ task.project.customer.name|truncatechars:20 }}{% else %}-{% endif %}
                    </td>
                    <td class="px-3 py-3">
                        {% if task.deadline %}
                        <span class="{% if task.is_overdue %}text-danger fw-bold{% endif %}">{{ task.deadline|date:"d/m/Y" }}</span>
                        {% if task.is_overdue %}<div class="small text-danger">‚ö†Ô∏è ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î!</div>{% endif %}
                        {% else %}<span class="text-muted">-</span>{% endif %}
                    </td>
                    <td class="px-3 py-3">
                        <form action="{% url 'pms:update_pending_task' task.id %}" method="post" class="d-flex flex-column gap-1">
                            {% csrf_token %}
                            <select name="team" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° --</option>
                                {% for team in teams %}
                                <option value="{{ team.id }}" {% if task.assigned_team_id == team.id %}selected{% endif %}>
                                    {{ team.name }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if task.assigned_team %}
                            <div class="small text-success"><i class="fas fa-robot me-1"></i>{{ task.ai_urgency_reason|truncatechars:30 }}</div>
                            {% endif %}
                    </td>
                    <td class="px-3 py-3">
                            <input type="date" name="scheduled_date" class="form-control form-control-sm"
                                value="{{ task.scheduled_date|date:'Y-m-d' }}"
                                onchange="this.form.submit()">
                        </form>
                    </td>
                    <td class="px-3 py-3">
                        {% if task.assigned_team and task.scheduled_date %}
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>‡∏û‡∏£‡πâ‡∏≠‡∏°</span>
                        {% elif task.assigned_team or task.scheduled_date %}
                        <span class="badge bg-secondary">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö</span>
                        {% else %}
                        <span class="badge bg-light text-muted">‡∏£‡∏≠</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile Pending Cards -->
    <div class="d-md-none p-3">
        {% for task in pending_tasks %}
        <div class="task-card-mobile">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <div class="task-title">{{ task.title }}</div>
                    {% if task.completion_note %}
                    <div class="small text-danger fw-bold mb-1" style="font-size: 0.75rem;"><i class="fas fa-exclamation-triangle me-1"></i>‡∏¢‡∏Å‡∏¢‡∏≠‡∏î: {{ task.completion_note|truncatechars:80 }}</div>
                    {% endif %}
                    {% if task.project %}
                    <a href="{% url 'pms:project_detail' task.project.pk %}" class="badge bg-info text-decoration-none" style="font-size: 0.65rem;">
                        {{ task.project.name|truncatechars:20 }}
                    </a>
                    {% endif %}
                </div>
                {% if task.task_type == 'REPAIR' %}<span class="badge badge-repair" style="font-size: 0.65rem;"><i class="fas fa-wrench"></i></span>
                {% elif task.task_type == 'DELIVERY' %}<span class="badge badge-delivery" style="font-size: 0.65rem;"><i class="fas fa-truck"></i></span>
                {% elif task.task_type == 'INSTALLATION' %}<span class="badge badge-install" style="font-size: 0.65rem;"><i class="fas fa-tools"></i></span>
                {% else %}<span class="badge badge-other" style="font-size: 0.65rem;"><i class="fas fa-list"></i></span>{% endif %}
            </div>
            <div class="task-meta mb-2">
                {% if task.project %}{{ task.project.customer.name|truncatechars:20 }}{% endif %}
                {% if task.deadline %} ‚Ä¢ ‡∏™‡πà‡∏á {{ task.deadline|date:"d/m" }}{% endif %}
                {% if task.is_overdue %}<span class="text-danger fw-bold"> ‚ö†Ô∏è</span>{% endif %}
            </div>
            <form action="{% url 'pms:update_pending_task' task.id %}" method="post" class="d-flex gap-2">
                {% csrf_token %}
                <select name="team" class="form-select form-select-sm" onchange="this.form.submit()" style="font-size: 0.8rem;">
                    <option value="">-- ‡∏ó‡∏µ‡∏° --</option>
                    {% for team in teams %}
                    <option value="{{ team.id }}" {% if task.assigned_team_id == team.id %}selected{% endif %}>{{ team.name }}</option>
                    {% endfor %}
                </select>
                <input type="date" name="scheduled_date" class="form-control form-control-sm" style="font-size: 0.8rem;"
                    value="{{ task.scheduled_date|date:'Y-m-d' }}" onchange="this.form.submit()">
            </form>
            {% if task.assigned_team and task.scheduled_date %}
            <div class="mt-2"><span class="badge bg-success" style="font-size: 0.65rem;"><i class="fas fa-check me-1"></i>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</span></div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <div class="card-footer bg-light text-muted small text-center py-2">
        <i class="fas fa-info-circle me-1"></i> ‡πÉ‡∏™‡πà <strong>‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</strong> ‡πÅ‡∏•‡∏∞ <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</strong> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <strong>"‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß+AI"</strong>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
        <i class="fas fa-check-circle" style="font-size: 2.5rem;"></i>
        <p class="mt-3 mb-0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß üéâ</p>
        <p class="small">‡πÄ‡∏°‡∏∑‡πà‡∏≠ Project/Repair ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏ã‡πà‡∏≠‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö" ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
    </div>
    {% endif %}
</div>

<!-- ============ BLOCK 2+: Scheduled Tasks (Grouped by Date) ============ -->
{% if date_groups %}
{% for date, tasks in date_groups.items %}
<div class="date-block">
    <div class="date-block-header {% if date == today %}date-block-today{% elif date < today %}date-block-past{% endif %}">
        <span>
            <i class="fas fa-calendar-alt me-2"></i>
            {% if date == today %}üìå ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Äî {% endif %}
            {{ date|date:"l, d F Y" }}
        </span>
        <span class="badge bg-white {% if date == today %}text-primary{% elif date < today %}text-danger{% else %}text-success{% endif %}">
            {{ tasks|length }} ‡∏á‡∏≤‡∏ô
        </span>
    </div>
    <div class="card border-0 shadow-sm" style="border-radius: 0 0 var(--radius-md) var(--radius-md);">
        <!-- Desktop -->
        <div class="table-responsive d-none d-md-block">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light">
                    <tr class="small text-uppercase text-muted">
                        <th class="px-3 py-2" style="width:70px;">‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th class="px-3 py-2">‡∏á‡∏≤‡∏ô</th>
                        <th class="px-3 py-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th class="px-3 py-2">‡∏ó‡∏µ‡∏°</th>
                        <th class="px-3 py-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
                        <th class="px-3 py-2" style="min-width:200px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td class="px-3 py-3">
                            {% if task.scheduled_time %}
                            <span class="fw-bold font-monospace">{{ task.scheduled_time|time:"H:i" }}</span>
                            {% else %}<span class="text-muted">-</span>{% endif %}
                        </td>
                        <td class="px-3 py-3">
                            <div class="fw-semibold">{{ task.title }}</div>
                            {% if task.project %}
                            <a href="{% url 'pms:project_detail' task.project.pk %}" class="badge bg-info text-decoration-none small">
                                {{ task.project.name|truncatechars:25 }}
                            </a>
                            {% endif %}
                        </td>
                        <td class="px-3 py-3">
                            {% if task.task_type == 'REPAIR' %}<span class="badge badge-repair"><i class="fas fa-wrench me-1"></i>‡∏ã‡πà‡∏≠‡∏°</span>
                            {% elif task.task_type == 'DELIVERY' %}<span class="badge badge-delivery"><i class="fas fa-truck me-1"></i>‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</span>
                            {% elif task.task_type == 'INSTALLATION' %}<span class="badge badge-install"><i class="fas fa-tools me-1"></i>‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</span>
                            {% else %}<span class="badge badge-other"><i class="fas fa-list me-1"></i>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>{% endif %}
                        </td>
                        <td class="px-3 py-3">
                            {% if task.assigned_team %}
                            <div class="team-pill"><i class="fas fa-users text-muted small"></i> {{ task.assigned_team.name }}</div>
                            {% else %}<span class="text-muted">-</span>{% endif %}
                        </td>
                        <td class="px-3 py-3">
                            {% if task.deadline %}
                            <span class="{% if task.is_overdue %}text-danger fw-bold{% endif %}">{{ task.deadline|date:"d/m/Y" }}</span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-3 py-3">
                            <form action="{% url 'pms:update_task_status' task.id %}" method="post" class="d-flex gap-1">
                                {% csrf_token %}
                                <select name="status" onchange="this.form.submit()" class="form-select form-select-sm"
                                    style="max-width:160px;
                                    {% if task.status == 'COMPLETED' %}border-color:#22c55e;background:#f0fdf4;
                                    {% elif task.status == 'IN_PROGRESS' %}border-color:#3b82f6;background:#eff6ff;
                                    {% elif task.status == 'INCOMPLETE' %}border-color:#ef4444;background:#fef2f2;{% endif %}">
                                    <option value="SCHEDULED" {% if task.status == 'SCHEDULED' %}selected{% endif %}>üìã ‡∏£‡∏≠‡∏ó‡∏≥</option>
                                    <option value="IN_PROGRESS" {% if task.status == 'IN_PROGRESS' %}selected{% endif %}>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                                    <option value="COMPLETED" {% if task.status == 'COMPLETED' %}selected{% endif %}>‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à</option>
                                    <option value="INCOMPLETE" {% if task.status == 'INCOMPLETE' %}selected{% endif %}>‚ùå ‡∏¢‡∏Å‡∏¢‡∏≠‡∏î</option>
                                </select>
                                <input type="text" name="note" placeholder="‡πÇ‡∏ô‡πâ‡∏ï" class="form-control form-control-sm" style="max-width:120px;">
                            </form>
                            {% if task.completion_note %}
                            <div class="small text-muted mt-1">üìù {{ task.completion_note|truncatechars:40 }}</div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile -->
        <div class="d-md-none p-3">
            {% for task in tasks %}
            <div class="task-card-mobile {% if task.status == 'COMPLETED' %}opacity-75{% endif %}">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <div>
                        <div class="task-title">
                            {% if task.scheduled_time %}<span class="font-monospace text-primary me-1">{{ task.scheduled_time|time:"H:i" }}</span>{% endif %}
                            {{ task.title }}
                        </div>
                        {% if task.project %}
                        <a href="{% url 'pms:project_detail' task.project.pk %}" class="badge bg-info text-decoration-none" style="font-size: 0.6rem;">
                            {{ task.project.name|truncatechars:20 }}
                        </a>
                        {% endif %}
                    </div>
                    {% if task.assigned_team %}
                    <div class="team-pill" style="font-size: 0.65rem;">{{ task.assigned_team.name }}</div>
                    {% endif %}
                </div>
                <div class="task-meta mb-2">
                    {% if task.task_type == 'REPAIR' %}‡∏ã‡πà‡∏≠‡∏°{% elif task.task_type == 'DELIVERY' %}‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á{% elif task.task_type == 'INSTALLATION' %}‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á{% else %}‡∏≠‡∏∑‡πà‡∏ô‡πÜ{% endif %}
                    {% if task.deadline %} ‚Ä¢ ‡∏™‡πà‡∏á {{ task.deadline|date:"d/m" }}{% endif %}
                </div>
                <form action="{% url 'pms:update_task_status' task.id %}" method="post" class="d-flex gap-2">
                    {% csrf_token %}
                    <select name="status" onchange="this.form.submit()" class="form-select form-select-sm" style="font-size: 0.8rem;
                        {% if task.status == 'COMPLETED' %}border-color:#22c55e;background:#f0fdf4;
                        {% elif task.status == 'IN_PROGRESS' %}border-color:#3b82f6;background:#eff6ff;
                        {% elif task.status == 'INCOMPLETE' %}border-color:#ef4444;background:#fef2f2;{% endif %}">
                        <option value="SCHEDULED" {% if task.status == 'SCHEDULED' %}selected{% endif %}>üìã ‡∏£‡∏≠</option>
                        <option value="IN_PROGRESS" {% if task.status == 'IN_PROGRESS' %}selected{% endif %}>üîÑ ‡∏ó‡∏≥</option>
                        <option value="COMPLETED" {% if task.status == 'COMPLETED' %}selected{% endif %}>‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à</option>
                        <option value="INCOMPLETE" {% if task.status == 'INCOMPLETE' %}selected{% endif %}>‚ùå ‡∏¢‡∏Å‡∏¢‡∏≠‡∏î</option>
                    </select>
                    <input type="text" name="note" placeholder="‡πÇ‡∏ô‡πâ‡∏ï..." class="form-control form-control-sm" style="font-size: 0.8rem;">
                </form>
                {% if task.completion_note %}
                <div class="small text-muted mt-1">üìù {{ task.completion_note|truncatechars:35 }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endfor %}

{% elif not pending_tasks %}
<div class="card border-0 shadow-sm">
    <div class="card-body text-center py-5 text-muted">
        <i class="fas fa-clipboard-check" style="font-size: 3rem;"></i>
        <p class="mt-3 fs-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß</p>
        <p class="small">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°/‡∏Ç‡∏≤‡∏¢/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà Block ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    </div>
</div>
{% endif %}

{% endblock %}
