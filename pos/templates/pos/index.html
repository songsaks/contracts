{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Shop POS</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --brand-primary: #3b82f6; /* Blue for fresh milk feel */
            --brand-secondary: #facc15; /* Yellow for happiness/honey */
            --bg-page: #f0f9ff;
        }
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-page);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        @media (min-width: 1024px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1.5rem;
                padding: 1.5rem;
            }
        }

        /* Edit Mode Styles */
        body.edit-mode .edit-overlay { display: flex; }
        .edit-overlay { display: none; }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <div class="h-16 bg-white border-b border-blue-100 flex justify-between items-center px-6 shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl">M</div>
            <h1 class="text-xl font-bold text-slate-800">Milk Shop POS</h1>
        </div>
        
        <div class="flex items-center gap-4">
            <label class="flex items-center gap-2 cursor-pointer bg-slate-100 px-3 py-1.5 rounded-full hover:bg-slate-200 transition">
                <span class="text-sm font-medium text-slate-600">Edit Mode</span>
                <input type="checkbox" id="editModeToggle" class="w-4 h-4 accent-blue-500 rounded cursor-pointer" onchange="toggleEditMode(this)">
            </label>
            <button onclick="openReportModal()" class="flex items-center gap-2 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1.5 rounded-full transition font-bold text-sm">
                <span>ðŸ“Š Report</span>
            </button>
            <div class="flex items-center gap-3 border-l pl-4 border-slate-200 ml-2">
                <div class="flex flex-col items-end leading-tight">
                    <span class="text-xs text-slate-400 font-medium uppercase">Operator</span>
                    <span class="text-sm font-bold text-slate-700">{{ user.username|default:'Guest' }}</span>
                </div>
                <form action="{% url 'logout' %}" method="post" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="bg-slate-100 hover:bg-red-50 text-slate-500 hover:text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Logout
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Categories Top Bar -->
    <div class="bg-white border-b border-slate-200 px-6 py-3 flex items-center gap-4 shrink-0 z-10 w-full">
        <!-- Search -->
        <div class="relative w-64 shrink-0">
             <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
             </span>
             <input type="text" id="searchInput" placeholder="Search..." class="w-full bg-slate-100 border-none rounded-full pl-9 pr-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <div class="h-6 w-px bg-slate-200 shrink-0"></div>

        <!-- Categories List -->
        <div class="flex-1 flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar" id="categoryList">
            <button onclick="filterCategory('all', this)" class="category-btn shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all active bg-blue-600 text-white shadow-md shadow-blue-200">
                All Products
            </button>
            {% for cat in categories %}
            <button onclick="filterCategory('{{ cat.id }}', this)" class="category-btn shrink-0 px-4 py-2 rounded-full text-sm font-bold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 transition-all">
                {{ cat.name }}
            </button>
            {% endfor %}
        </div>
        
        <!-- Add Product & Manage Category Buttons (Visible in Edit Mode) -->
        <div class="edit-overlay shrink-0 gap-2">
             <button onclick="openCategoryModal()" class="flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-full font-bold shadow-lg shadow-amber-200 transition text-sm">
                <span>ðŸ“‚ Categories</span>
            </button>
             <button onclick="openProductModal()" class="flex items-center gap-2 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-full font-bold shadow-lg shadow-green-200 transition text-sm">
                <span>+ Product</span>
            </button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex-1 overflow-hidden grid lg:grid-cols-[1fr_390px] grid-cols-1">
        


        <!-- 2. Products Grid -->
        <div class="bg-blue-50/50 flex flex-col h-full overflow-hidden relative">
            <div class="flex-1 overflow-y-auto p-6" id="productsContainer">
                <div class="product-grid">
                    {% for product in products %}
                    <div class="product-card group relative bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer hover:shadow-md transition-all active:scale-95 duration-100 select-none flex flex-col h-[220px] lg:h-[260px]"
                         data-id="{{ product.id }}"
                         data-category="{{ product.category.id|default:'none' }}"
                         data-name="{{ product.name|lower }}"
                         onclick="handleProductClick({{ product.id }})">
                        
                        <!-- Image -->
                        <div class="h-32 lg:h-40 bg-slate-100 w-full relative overflow-hidden">
                             {% if product.image %}
                            <img src="{{ product.image.url }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                             {% else %}
                            <div class="w-full h-full flex items-center justify-center text-slate-300">No Image</div>
                             {% endif %}
                            
                            <!-- Price Tag -->
                            <div class="absolute bottom-2 right-2 bg-white/90 backdrop-blur px-2.5 py-0.5 lg:px-3 lg:py-1 rounded-full font-bold text-slate-800 shadow-sm text-xs lg:text-sm">
                                &#3647;{{ product.price|floatformat:0 }}
                            </div>
                        </div>

                        <!-- Info -->
                        <div class="p-3 flex flex-col flex-1 justify-between">
                            <h4 class="font-bold text-slate-800 text-lg leading-tight line-clamp-2" title="{{ product.name }}">{{ product.name }}</h4>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-xs text-slate-500">Stock: {{ product.stock }}</span>
                            </div>
                        </div>

                        <!-- Edit Overlay (Edit Mode) -->
                        <div class="edit-overlay absolute inset-0 bg-black/40 items-center justify-center backdrop-blur-[2px] opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); openEditModal({{ product.id }})" class="bg-white text-slate-800 px-4 py-2 rounded-full font-bold hover:bg-blue-500 hover:text-white transition shadow-lg transform hover:scale-110">
                                Edit
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 3. Cart Section -->
        <div class="bg-white border-l border-slate-200 flex flex-col h-full shadow-xl z-20 absolute inset-0 lg:static transition-transform transform translate-x-full lg:translate-x-0" id="mobileCartPanel">
            <!-- Mobile Cart Header -->
            <div class="p-4 bg-slate-800 text-white lg:hidden flex justify-between items-center">
                 <h2 class="font-bold text-lg">My Cart</h2>
                 <button onclick="toggleMobileCart()" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition">&times;</button>
            </div>
            <div class="p-6 border-b border-slate-100 bg-white">
                <h2 class="text-2xl font-bold text-slate-800">Current Order</h2>
                <div class="text-sm text-slate-500 mt-1" id="orderDate">Today, ...</div>
            </div>

            <!-- Cart Items -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3" id="cartContainer">
                <div class="text-center text-slate-400 mt-10">
                    <svg class="w-16 h-16 mx-auto mb-4 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    <p>Cart is empty</p>
                    <p class="text-xs">Select products to add</p>
                </div>
            </div>

            <!-- Cart Footer -->
            <div class="p-6 bg-slate-50 border-t border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-slate-600 font-medium">Subtotal</span>
                    <span class="text-slate-800 font-bold" id="cartSubtotal">&#3647;0.00</span>
                </div>
                <div class="flex justify-between items-center mb-6 text-2xl font-extrabold text-blue-600">
                    <span>Total</span>
                    <span id="cartTotal">&#3647;0.00</span>
                </div>
                
                <button onclick="openCheckoutModal()" disabled id="checkoutBtn" class="w-full py-4 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-xl font-bold text-lg shadow-lg shadow-blue-500/30 transition-all active:scale-[0.98]">
                    Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Cart Toggle Button -->
    <button onclick="toggleMobileCart()" class="fixed bottom-6 right-6 lg:hidden z-30 bg-blue-600 text-white p-4 rounded-full shadow-lg shadow-blue-500/40 transform active:scale-95 transition-all flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full" id="mobileCartCount">0</span>
    </button>

    <!-- Product Modal (Add/Edit) -->
    <div id="productModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-slate-800" id="modalTitle">Add Product</h3>
                <button onclick="closeProductModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            
            <form id="productForm" onsubmit="handleProductSubmit(event)" class="p-6 space-y-4" enctype="multipart/form-data">
                <input type="hidden" name="id" id="productId">
                <input type="hidden" name="is_active" value="True">
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Product Name</label>
                    <input type="text" name="name" id="pName" required class="w-full sm:text-lg p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Price (&#3647;)</label>
                        <input type="number" step="0.01" name="price" id="pPrice" required class="w-full text-right font-mono p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Stock</label>
                        <input type="number" name="stock" id="pStock" required class="w-full text-right font-mono p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">code</label>
                        <input type="text" name="code" id="pCode" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                        <select name="category" id="pCategory" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                            <option value="">None</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Image</label>
                    <input type="file" name="image" id="pImageInput" accept="image/*" onchange="previewImage(this)" class="w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <div class="mt-2 h-32 w-full bg-slate-50 rounded-xl border border-slate-200 overflow-hidden flex items-center justify-center relative">
                        <img id="pImagePreview" class="h-full w-full object-contain hidden">
                        <span id="pNoImageText" class="text-slate-400 text-sm">No image selected</span>
                    </div>
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="w-full py-3.5 bg-brand-primary bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="p-6 bg-slate-900 text-white text-center">
                <h2 class="text-3xl font-bold" id="modalTotalAmount">&#3647;0.00</h2>
                
                <div class="flex items-center justify-center gap-2 mt-2">
                    <span class="text-slate-400 text-sm">Discount</span>
                    <input type="number" id="discountAmount" placeholder="0" class="w-16 bg-slate-800 text-white text-center rounded border border-slate-700 text-sm py-0.5 focus:border-blue-500 outline-none" oninput="calculateDiscount()">
                </div>
                
                <p class="text-slate-400 text-sm mt-1">Total Payable</p>
                <!-- Hidden Original Total for Calculation -->
                <input type="hidden" id="originalTotalAmount"> 
            </div>
            
            <div class="p-6">
                <!-- Payment Method -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="selectPayment('CASH')" id="pmCash" class="p-4 rounded-xl border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold flex flex-col items-center gap-2 transition-all">
                        <span>ðŸ’µ Cash</span>
                    </button>
                    <button onclick="selectPayment('QR')" id="pmQr" class="p-4 rounded-xl border-2 border-slate-100 text-slate-500 font-bold flex flex-col items-center gap-2 transition-all hover:bg-slate-50">
                        <span>ðŸ“± Scan QR</span>
                    </button>
                </div>

                <!-- Cash Fields -->
                <div id="cashInterface" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wide">Received Amount</label>
                        <input type="number" id="receivedAmount" placeholder="0.00" oninput="calculateChange()" class="w-full text-3xl font-bold text-center p-3 border-b-2 border-slate-200 focus:border-blue-500 outline-none bg-transparent">
                    </div>
                    
                    <div class="bg-green-50 rounded-xl p-4 flex justify-between items-center">
                        <span class="text-green-800 font-bold">Change</span>
                        <span class="text-2xl font-bold text-green-600" id="changeAmount">&#3647;0.00</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-8">
                    <button onclick="closeCheckoutModal()" class="py-3.5 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition">Cancel</button>
                    <button onclick="processOrder()" class="py-3.5 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">Confirm Payment</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sales Report Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-100 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-200 flex flex-col gap-4 bg-white">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800">Sales & Stock Report</h3>
                    <button onclick="closeReportModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div class="flex items-end gap-2 text-sm">
                    <div class="flex flex-col gap-1">
                        <label class="font-bold text-slate-500 text-xs uppercase">Start Date</label>
                        <input type="date" id="reportStartDate" class="p-2 border border-slate-200 rounded-lg outline-none focus:border-blue-500">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="font-bold text-slate-500 text-xs uppercase">End Date</label>
                        <input type="date" id="reportEndDate" class="p-2 border border-slate-200 rounded-lg outline-none focus:border-blue-500">
                    </div>
                    <button onclick="loadReportData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition shadow-md shadow-blue-200">
                        Filter
                    </button>
                    <button onclick="setTodayDate()" class="px-3 py-2 text-slate-500 hover:bg-slate-200 rounded-lg transition font-medium">
                        Today
                    </button>
                </div>
                </div>
                
                <!-- Report Tabs -->
                <div class="flex border-b border-slate-200 mt-2">
                    <button onclick="viewReportTab('summary')" id="tab-summary" class="px-4 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition">Summary</button>
                    <button onclick="viewReportTab('details')" id="tab-details" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-blue-600 transition">Product Details</button>
                </div>
            </div>
            
            <div class="p-6 overflow-y-auto" id="reportContent">
                 <!-- Content loaded via JS -->
                 <div class="flex justify-center py-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
            </div>
            
            <!-- Export Footer (only visible in details tab) -->
            <div id="reportFooter" class="p-4 border-t border-slate-200 bg-white hidden justify-end">
                <button onclick="exportReport()" class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg shadow-green-200 transition">
                    <span>ðŸ“¥ Export to CSV</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Category Manager Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black/60 hidden z-[80] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-slate-800">Manage Categories</h3>
                <button onclick="closeCategoryModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            
            <div class="p-6 bg-slate-50 border-b border-slate-100">
                <form onsubmit="handleCategoryCreate(event)" class="flex gap-2">
                    <input type="text" name="name" placeholder="New Category Name" required class="flex-1 p-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold transition shadow-lg shadow-blue-200">Add</button>
                </form>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-3" id="categoryListContainer">
                <!-- Loaded via JS -->
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 pointer-events-none transition-all duration-300 z-[100] transform translate-y-4">Message</div>

    {% csrf_token %}

    <script>
        // State
        let products = [
            {% for p in products %}
            {
                id: {{ p.id }},
                name: "{{ p.name|escapejs }}",
                price: parseFloat("{{ p.price }}"),
                stock: {{ p.stock }},
                category: "{{ p.category.id|default:'none' }}",
                image: "{% if p.image %}{{ p.image.url }}{% endif %}",
                code: "{{ p.code|default:'' }}"
            },
            {% endfor %}
        ];
        
        let cart = {}; // { productId: qty }
        let currentCategory = 'all';
        let isEditMode = false;
        let selectedPayment = 'CASH';
        
        let allCategories = [
            {% for cat in categories %}
            { id: {{ cat.id }}, name: "{{ cat.name|escapejs }}" },
            {% endfor %}
        ];

        // --- Core Functions ---

        function init() {
            document.getElementById('orderDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        init();

        function toggleEditMode(checkbox) {
            isEditMode = checkbox.checked;
            document.body.classList.toggle('edit-mode', isEditMode);
            // Re-render handled by CSS mostly, but if logical changes needed...
        }
        
        function toggleMobileCart() {
            const panel = document.getElementById('mobileCartPanel');
            panel.classList.toggle('translate-x-full');
        }

        // --- Product Management ---

        function filterCategory(catId, btn) {
            currentCategory = catId;
            
            // UI Update
            document.querySelectorAll('.category-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'shadow-blue-200');
                b.classList.add('bg-white', 'text-slate-600', 'border', 'border-slate-200');
            });
            btn.classList.remove('bg-white', 'text-slate-600', 'border', 'border-slate-200');
            btn.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'shadow-blue-200');

            applyFilter();
        }

        document.getElementById('searchInput').addEventListener('input', applyFilter);

        function applyFilter() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const container = document.querySelector('.product-grid');
            const cards = container.children;
            
            for (let card of cards) {
                const name = card.dataset.name;
                const cat = card.dataset.category;
                
                const matchSearch = name.includes(term);
                const matchCat = currentCategory === 'all' || cat === currentCategory;
                
                card.style.display = (matchSearch && matchCat) ? 'flex' : 'none';
            }
        }

        function handleProductClick(originalId) {
            if (isEditMode) return; // Prevent clicking card in edit mode (overlay handles it)
            addToCart(originalId);
        }

        // --- Cart Logic ---

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if ((cart[productId] || 0) >= product.stock) {
                showToast("Not enough stock!", true);
                return;
            }

            cart[productId] = (cart[productId] || 0) + 1;
            renderCart();
            animateFlyToCart(productId);
        }

        function removeFromCart(productId) {
            if (cart[productId]) {
                cart[productId]--;
                if (cart[productId] <= 0) delete cart[productId];
                renderCart();
            }
        }

        function renderCart() {
            const container = document.getElementById('cartContainer');
            container.innerHTML = '';
            let total = 0;
            let count = 0;

            for (const [id, qty] of Object.entries(cart)) {
                const product = products.find(p => p.id == id);
                if (!product) continue;
                
                total += product.price * qty;
                count++;

                const el = document.createElement('div');
                el.className = 'bg-slate-50 p-3 rounded-xl flex items-center gap-3 animate-[fadeIn_0.2s_ease-out]';
                el.innerHTML = `
                    <div class="w-12 h-12 rounded-lg bg-white bg-cover bg-center shrink-0 border border-slate-200" 
                         style="background-image: url('${product.image || 'https://via.placeholder.com/50'}')"></div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-slate-800 text-sm truncate">${product.name}</div>
                        <div class="text-blue-600 font-bold text-xs">&#3647;${product.price.toFixed(0)}</div>
                    </div>
                    <div class="flex items-center gap-2 bg-white rounded-lg p-1 border border-slate-200 shadow-sm">
                        <button onclick="removeFromCart(${id})" class="w-6 h-6 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition font-bold">-</button>
                        <span class="w-6 text-center font-bold text-sm">${qty}</span>
                        <button onclick="addToCart(${id})" class="w-6 h-6 flex items-center justify-center text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded transition font-bold">+</button>
                    </div>
                `;
                container.appendChild(el);
            }

            if (count === 0) {
                container.innerHTML = `
                <div class="text-center text-slate-400 mt-10">
                    <svg class="w-16 h-16 mx-auto mb-4 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    <p>Cart is empty</p>
                    <p class="text-xs">Select products to add</p>
                </div>`;
                document.getElementById('checkoutBtn').disabled = true;
            } else {
                document.getElementById('checkoutBtn').disabled = false;
            }

            document.getElementById('cartSubtotal').innerHTML = count > 0 ? '&#3647;' + total.toFixed(2) : '&#3647;0.00';
            document.getElementById('cartTotal').innerHTML = count > 0 ? '&#3647;' + total.toFixed(2) : '&#3647;0.00';
            
            // Update Modal Total too
            document.getElementById('modalTotalAmount').innerHTML = '&#3647;' + total.toFixed(2);
            
            // Update Mobile Badge
            const mobCount = document.getElementById('mobileCartCount');
            if(mobCount) mobCount.innerText = count;
        }

        // --- Modals (Edit/Add) ---

        function previewImage(input) {
            const preview = document.getElementById('pImagePreview');
            const noImgText = document.getElementById('pNoImageText');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    noImgText.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.src = '';
                preview.classList.add('hidden');
                noImgText.classList.remove('hidden');
            }
        }

        function openProductModal() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            
            // Reset Preview
            document.getElementById('pImagePreview').src = '';
            document.getElementById('pImagePreview').classList.add('hidden');
            document.getElementById('pNoImageText').classList.remove('hidden');
            
            document.getElementById('modalTitle').textContent = 'Add New Product';
            document.getElementById('productModal').classList.remove('hidden');
        }

        function openEditModal(prodId) {
             const product = products.find(p => p.id === prodId);
             if(!product) return;
             
             document.getElementById('productId').value = product.id;
             document.getElementById('pName').value = product.name;
             document.getElementById('pPrice').value = product.price;
             document.getElementById('pStock').value = product.stock;
             document.getElementById('pCode').value = product.code;
             document.getElementById('pCategory').value = product.category === 'none' ? '' : product.category;
             
             // Set Preview
             const preview = document.getElementById('pImagePreview');
             const noImgText = document.getElementById('pNoImageText');
             if(product.image) {
                 preview.src = product.image;
                 preview.classList.remove('hidden');
                 noImgText.classList.add('hidden');
             } else {
                 preview.src = '';
                 preview.classList.add('hidden');
                 noImgText.classList.remove('hidden');
             }

             document.getElementById('modalTitle').textContent = 'Edit Product';
             document.getElementById('productModal').classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
        }

        async function handleProductSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const isEdit = !!formData.get('id');
            const url = isEdit ? `/pos/api/products/${formData.get('id')}/update/` : '/pos/api/products/create/';
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                    body: formData
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    console.log('Product saved:', data.product);
                    showToast(isEdit ? "Product Updated" : "Product Created");
                    closeProductModal();
                    setTimeout(() => window.location.reload(), 500); // Reload to simplisticly update UI
                } else {
                    alert('Error: ' + JSON.stringify(data.errors));
                }
            } catch (err) {
                console.error(err);
                alert('Network Error');
            }
        }

        // --- Checkout & Payment ---

        function openCheckoutModal() {
            // Get original total from Cart
            const totalStr = document.getElementById('cartTotal').innerText.replace('à¸¿', '');
            document.getElementById('originalTotalAmount').value = totalStr;
            document.getElementById('modalTotalAmount').innerText = 'à¸¿' + totalStr;
            
            // Reset fields
            document.getElementById('receivedAmount').value = '';
            document.getElementById('discountAmount').value = '';
            document.getElementById('changeAmount').innerText = 'à¸¿0.00';
            
            selectPayment('CASH');
            document.getElementById('checkoutModal').classList.remove('hidden');
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.add('hidden');
        }

        function selectPayment(method) {
            selectedPayment = method;
            const cashBtn = document.getElementById('pmCash');
            const qrBtn = document.getElementById('pmQr');
            const cashUI = document.getElementById('cashInterface');
            
            if (method === 'CASH') {
                cashBtn.className = "p-4 rounded-xl border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold flex flex-col items-center gap-2 transition-all shadow-md";
                qrBtn.className = "p-4 rounded-xl border-2 border-slate-100 text-slate-500 font-bold flex flex-col items-center gap-2 transition-all hover:bg-slate-50 opacity-60";
                cashUI.style.display = 'block';
            } else {
                qrBtn.className = "p-4 rounded-xl border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold flex flex-col items-center gap-2 transition-all shadow-md";
                cashBtn.className = "p-4 rounded-xl border-2 border-slate-100 text-slate-500 font-bold flex flex-col items-center gap-2 transition-all hover:bg-slate-50 opacity-60";
                cashUI.style.display = 'none';
            }
        }
        
        function calculateDiscount() {
            const originalTotal = parseFloat(document.getElementById('originalTotalAmount').value) || 0;
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            
            const newTotal = Math.max(0, originalTotal - discount);
            document.getElementById('modalTotalAmount').innerText = 'à¸¿' + newTotal.toFixed(2);
            calculateChange();
        }

        function calculateChange() {
            const received = parseFloat(document.getElementById('receivedAmount').value) || 0;
            const totalStr = document.getElementById('modalTotalAmount').innerText.replace('à¸¿', '');
            const total = parseFloat(totalStr);
            const change = received - total;
            document.getElementById('changeAmount').innerText = 'à¸¿' + (change >= 0 ? change.toFixed(2) : '0.00');
        }

        async function processOrder() {
            const received = parseFloat(document.getElementById('receivedAmount').value) || 0;
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            const totalStr = document.getElementById('modalTotalAmount').innerText.replace('à¸¿', '');
            const total = parseFloat(totalStr);
            
            if (selectedPayment === 'CASH' && received < total) {
                showToast("Insufficient Amount", true);
                return;
            }

            const items = Object.entries(cart).map(([id, qty]) => ({ id: id, quantity: qty }));
            
            try {
                const res = await fetch('/pos/api/order/process/', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value 
                    },
                    body: JSON.stringify({ items, payment_method: selectedPayment })
                });
                
                const data = await res.json();
                if (data.status === 'success') {
                    showToast("Payment Successful!");
                    closeCheckoutModal();
                    cart = {};
                    renderCart();
                    setTimeout(() => window.location.reload(), 1000); // Full refresh to sync stock
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (err) {
                console.error(err);
                alert('Network Error');
            }
        }



        // --- Category Management ---

        function openCategoryModal() {
            renderCategoryManager();
            document.getElementById('categoryModal').classList.remove('hidden');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
        }

        function renderCategoryManager() {
            const container = document.getElementById('categoryListContainer');
            container.innerHTML = allCategories.map(cat => `
                <div class="flex items-center gap-2 bg-white p-3 rounded-xl border border-slate-100 shadow-sm group">
                    <input type="text" value="${cat.name}" id="cat-input-${cat.id}" class="flex-1 bg-transparent border-none outline-none font-bold text-slate-700 focus:bg-slate-50 focus:px-2 rounded transition" onchange="updateCategory(${cat.id}, this.value)">
                    <button onclick="deleteCategory(${cat.id})" class="text-slate-400 hover:text-red-500 p-2 rounded-lg hover:bg-red-50 transition opacity-0 group-hover:opacity-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        async function handleCategoryCreate(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                const res = await fetch('/pos/api/categories/create/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                    body: formData
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    showToast("Category Added");
                    form.reset();
                    // Update local state and reload to sync everything simplistically
                    setTimeout(() => window.location.reload(), 500); 
                } else {
                    alert('Error: ' + (data.message || 'Unknown error'));
                }
            } catch (err) {
                console.error(err);
                alert('Network Error');
            }
        }

        async function updateCategory(id, newName) {
            try {
                const formData = new FormData();
                formData.append('name', newName);
                
                const res = await fetch(`/pos/api/categories/${id}/update/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                    body: formData
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    showToast("Category Updated");
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    alert('Error updating category');
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function deleteCategory(id) {
            if(!confirm('Delete this category? Products in this category may become uncategorized.')) return;
            
            try {
                const res = await fetch(`/pos/api/categories/${id}/delete/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    showToast("Category Deleted");
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    alert('Error deleting category');
                }
            } catch (err) {
                console.error(err);
            }
        }

        // --- Report Logic ---

        let currentReportData = null;
        let activeReportTab = 'summary';

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        async function openReportModal() {
            document.getElementById('reportModal').classList.remove('hidden');
            
            // Set default date if empty
            if(!document.getElementById('reportStartDate').value) {
                setTodayDate(); 
            } else {
                loadReportData();
            }
        }
        
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
            loadReportData();
        }
        
        function viewReportTab(tab) {
            activeReportTab = tab;
            
            // Update Tab UI
            const summaryTab = document.getElementById('tab-summary');
            const detailsTab = document.getElementById('tab-details');
            const footer = document.getElementById('reportFooter');
            
            if(tab === 'summary') {
                summaryTab.className = "px-4 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition";
                detailsTab.className = "px-4 py-2 text-sm font-bold text-slate-500 hover:text-blue-600 transition";
                footer.classList.remove('flex');
                footer.classList.add('hidden');
            } else {
                detailsTab.className = "px-4 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition";
                summaryTab.className = "px-4 py-2 text-sm font-bold text-slate-500 hover:text-blue-600 transition";
                footer.classList.remove('hidden');
                footer.classList.add('flex');
            }
            
            renderReportContent();
        }

        async function loadReportData() {
            const container = document.getElementById('reportContent');
            const start = document.getElementById('reportStartDate').value;
            const end = document.getElementById('reportEndDate').value;
            
            // Show loading state
            container.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';

            try {
                const res = await fetch(`/pos/api/report/?start_date=${start}&end_date=${end}`);
                const json = await res.json();
                
                if (json.status === 'success') {
                    currentReportData = json.data; // Store for tab switching
                    renderReportContent();
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="text-red-500 text-center p-4">Failed to load report</div>';
            }
        }
        
        function renderReportContent() {
             const container = document.getElementById('reportContent');
             const data = currentReportData;
             if(!data) return;

             if (activeReportTab === 'summary') {
                container.innerHTML = `
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <div class="text-sm text-blue-600 font-bold mb-1">Total Sales (${data.period.start} - ${data.period.end})</div>
                                <div class="text-3xl font-bold text-blue-800">&#3647;${data.sales_amount.toFixed(2)}</div>
                                <div class="flex gap-4 mt-2 text-sm">
                                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Cash: &#3647;${data.cash_sales.toFixed(2)}</div>
                                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-indigo-500"></span> QR: &#3647;${data.qr_sales.toFixed(2)}</div>
                                </div>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl border border-amber-100">
                                <div class="text-sm text-amber-600 font-bold mb-1">Total Stock Value</div>
                                <div class="text-3xl font-bold text-amber-800">&#3647;${data.stock_value.toFixed(2)}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Low Stock -->
                            <div>
                                <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                                    <span class="bg-red-100 text-red-600 p-1 rounded">âš ï¸</span> Low Stock Items
                                </h4>
                                <div class="bg-white border border-slate-100 rounded-xl overflow-hidden">
                                    ${data.low_stock.length > 0 ? `
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-slate-50 text-slate-500">
                                                <tr>
                                                    <th class="p-3">Product</th>
                                                    <th class="p-3 text-right">Stock</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-100">
                                                ${data.low_stock.map(p => `
                                                    <tr>
                                                        <td class="p-3 font-medium text-slate-700 flex items-center gap-2">
                                                            ${p.image ? `<div class="w-6 h-6 rounded bg-slate-100 bg-cover bg-center" style="background-image:url('${p.image}')"></div>` : '<div class="w-6 h-6 bg-slate-200 rounded"></div>'}
                                                            ${p.name}
                                                        </td>
                                                        <td class="p-3 text-right font-bold text-red-500">${p.stock}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    ` : '<div class="p-4 text-center text-slate-400">All stock levels good</div>'}
                                </div>
                            </div>

                            <!-- Recent Orders -->
                            <div>
                                <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                                    <span class="bg-purple-100 text-purple-600 p-1 rounded">ðŸ•’</span> Recent Orders
                                </h4>
                                <div class="bg-white border border-slate-100 rounded-xl overflow-hidden">
                                   ${data.recent_orders.length > 0 ? `
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-slate-50 text-slate-500">
                                                <tr>
                                                    <th class="p-3">Time</th>
                                                    <th class="p-3">Method</th>
                                                    <th class="p-3 text-right">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-100">
                                                ${data.recent_orders.map(o => `
                                                    <tr>
                                                        <td class="p-3 text-slate-500">${new Date(o.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                                                        <td class="p-3 text-slate-700 font-medium">${o.payment_method}</td>
                                                        <td class="p-3 text-right font-bold text-slate-800">&#3647;${o.total_amount.toFixed(2)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    ` : '<div class="p-4 text-center text-slate-400">No orders yet</div>'}
                                </div>
                            </div>
                        </div>
                `;
             } else {
                 // Details Tab
                 container.innerHTML = `
                    <div class="overflow-x-auto rounded-xl border border-slate-200 bg-slate-50 shadow-sm">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-500 font-bold uppercase text-xs">
                                <tr>
                                    <th class="p-4">Product Name</th>
                                    <th class="p-4">Category</th>
                                    <th class="p-4 text-right">Price</th>
                                    <th class="p-4 text-right">Sold (Qty)</th>
                                    <th class="p-4 text-right">Revenue</th>
                                    <th class="p-4 text-right">Remain Stock</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                ${data.product_performance.map(p => `
                                    <tr>
                                        <td class="p-4 font-bold text-slate-700 bg-slate-100">${p.name} <span class="block text-xs text-slate-400 font-normal">${p.code}</span></td>
                                        <td class="p-4 text-slate-500">${p.category}</td>
                                        <td class="p-4 text-right text-slate-600">&#3647;${p.price.toFixed(2)}</td>
                                        <td class="p-4 text-right font-bold text-slate-700">${p.sold_qty}</td>
                                        <td class="p-4 text-right font-bold text-slate-700">&#3647;${p.revenue.toFixed(2)}</td>
                                        <td class="p-4 text-right font-bold ${p.stock < 10 ? 'text-red-500' : 'text-slate-600'}">${p.stock}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                 `;
             }
        }
        
        function exportReport() {
            const start = document.getElementById('reportStartDate').value;
            const end = document.getElementById('reportEndDate').value;
            window.location.href = `/pos/api/report/export/?start_date=${start}&end_date=${end}`;
        }

        // --- Utilities ---

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl transition-all duration-300 z-[100] transform text-white font-bold flex items-center gap-2 ${isError ? 'bg-red-500' : 'bg-slate-800'}`;
            // Hacky visible state
            t.style.opacity = '1';
            t.style.transform = 'translate(-50%, 0)';
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translate(-50%, 1rem)';
            }, 3000);
        }
        
        function animateFlyToCart(productId) {
            // Placeholder for animation logic if needed
        }
    </script>
</body>
</html>
