{% extends 'stocks/base_stocks.html' %}
{% load humanize %}

{% block content %}
<div class="row g-4">
    <!-- Summary Header -->
    <div class="col-12">
        <div class="card-premium p-4 border-0 mb-4 bg-primary bg-opacity-10">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h3 class="fw-bold mb-1 text-primary"><i class="fas fa-wallet me-2"></i> My Portfolio</h3>
                    <p class="text-muted mb-0">ติดตามสินทรัพย์ที่คุณครอบครอง (Owned Assets)</p>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <div class="d-flex justify-content-md-end gap-4">
                        <div>
                            <div class="small text-muted uppercase fw-600" style="letter-spacing: 0.5px;">TOTAL VALUE</div>
                            <div class="h4 fw-bold mb-0 text-dark">฿{{ total_market_value|floatformat:2|intcomma }}</div>
                        </div>
                        <div>
                            <div class="small text-muted uppercase fw-600" style="letter-spacing: 0.5px;">TOTAL P/L</div>
                            <div class="h4 fw-bold mb-0 {% if total_gain_loss > 0 %}stock-positive{% elif total_gain_loss < 0 %}stock-negative{% endif %}">
                                {% if total_gain_loss > 0 %}+{% endif %}฿{{ total_gain_loss|floatformat:2|intcomma }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Grid -->
    <div class="col-lg-12">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
            <h5 class="fw-bold mb-0">Assets ({{ items|length }})</h5>
            <div class="d-flex flex-wrap gap-2">
                {% if items|length > 0 %}
                <a href="?analyze=true" class="btn btn-outline-success btn-sm rounded-pill px-3 px-md-4">
                    <i class="fas fa-brain"></i> <span class="d-none d-sm-inline ms-1">Analyze</span>
                </a>
                {% endif %}
                <button class="btn btn-premium btn-sm rounded-pill px-3 px-md-4" data-bs-toggle="modal" data-bs-target="#addPortfolioModal">
                    <i class="fas fa-plus"></i> <span class="d-none d-sm-inline ms-1">Add</span>
                </button>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
            {% for item in items %}
            <div class="col">
                <div class="card-premium p-3 h-100 border-light border-opacity-50">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary">
                                {% if item.obj.category == 'STOCK' %}<i class="fas fa-building"></i>
                                {% elif item.obj.category == 'CRYPTO' %}<i class="fab fa-bitcoin"></i>
                                {% else %}<i class="fas fa-coins"></i>{% endif %}
                            </div>
                            <div>
                                <h5 class="fw-bold mb-0 text-dark">
                                    <a href="{% url 'stocks:analyze' item.obj.symbol %}" class="text-dark text-decoration-none hover-primary">
                                        {{ item.obj.symbol }}
                                    </a>
                                </h5>
                                <div class="text-muted-light" style="font-size: 0.75rem;">{{ item.obj.name|default:item.obj.symbol }}</div>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="h6 fw-bold mb-0">฿{{ item.current_price|floatformat:2|intcomma }}</div>
                            {% if item.rsi %}
                            <span class="badge {% if item.rsi < 30 %}bg-danger{% elif item.rsi > 70 %}bg-warning{% else %}bg-secondary{% endif %} bg-opacity-10 {% if item.rsi < 30 %}text-danger{% elif item.rsi > 70 %}text-warning text-dark{% else %}text-secondary{% endif %} rounded-pill" style="font-size: 0.65rem;">
                                RSI: {{ item.rsi|floatformat:1 }}
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="bg-light bg-opacity-50 p-3 rounded-4 mb-3">
                        <div class="row g-2 text-center">
                            <div class="col-4 border-end border-light">
                                <div class="text-muted small" style="font-size: 0.65rem;">QUANTITY</div>
                                <div class="fw-600 small">{{ item.obj.quantity|floatformat:2|intcomma }}</div>
                            </div>
                            <div class="col-4 border-end border-light">
                                <div class="text-muted small" style="font-size: 0.65rem;">AVG COST</div>
                                <div class="fw-600 small">฿{{ item.obj.entry_price|floatformat:2|intcomma }}</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small" style="font-size: 0.65rem;">P/L</div>
                                <div class="fw-600 small {% if item.gain_loss > 0 %}stock-positive{% elif item.gain_loss < 0 %}stock-negative{% endif %}">
                                    {{ item.gain_loss_pct|floatformat:1 }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">Value: <span class="fw-bold text-dark">฿{{ item.market_value|floatformat:2|intcomma }}</span></div>
                        <div class="d-flex gap-3 align-items-center">
                            <button type="button" class="btn btn-link text-primary p-0" style="font-size: 1rem;" 
                                onclick="editPortfolio('{{ item.obj.symbol }}', '{{ item.obj.name|default:""|escapejs }}', '{{ item.obj.quantity }}', '{{ item.obj.entry_price }}', '{{ item.obj.category }}')" 
                                data-bs-toggle="modal" data-bs-target="#addPortfolioModal">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form action="{% url 'stocks:delete_from_portfolio' item.obj.pk %}" method="POST" onsubmit="return confirm('ลบจากพอร์ตใช่หรือไม่?')">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-link text-danger p-0" style="font-size: 1rem;">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-5">
                <i class="fas fa-wallet fa-3x text-muted mb-3 opacity-25"></i>
                <p class="text-muted">ยังไม่มีรายการในพอร์ต</p>
                <button class="btn btn-outline-primary rounded-pill px-4 btn-sm" data-bs-toggle="modal" data-bs-target="#addPortfolioModal">เริ่มสร้างพอร์ต</button>
            </div>
            {% endfor %}
        </div>
    </div>

    {% if ai_analysis %}
    <div class="col-12 mt-4" id="ai-analysis-section">
        <div class="card-premium p-0 border-0 overflow-hidden mb-5">
            <div class="p-4 border-bottom bg-white d-flex flex-wrap justify-content-between align-items-center gap-3">
                <h4 class="fw-bold mb-0 text-success"><i class="fas fa-magic me-2 text-success"></i> บทวิเคราะห์พอร์ตการลงทุนด้วย AI</h4>
                <div class="d-flex flex-wrap align-items-center gap-2 d-print-none">
                    <button class="btn btn-outline-success btn-sm rounded-pill" onclick="exportHTMLToExcel('port-analysis-content', 'Portfolio_Analysis_Report')">
                        <i class="fas fa-file-excel"></i> <span class="d-none d-sm-inline ms-1">Excel</span>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="window.print()">
                        <i class="fas fa-print"></i> <span class="d-none d-sm-inline ms-1">Print</span>
                    </button>
                    <span class="badge bg-light text-muted fw-normal">Powered by Gemini AI</span>
                </div>
            </div>
            <div class="p-4 p-md-5 bg-white">
                <textarea id="ai-raw-markdown" style="display: none;">{{ ai_analysis }}</textarea>
                <div id="port-analysis-content" class="analysis-content">
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal -->
<div class="modal fade" id="addPortfolioModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card-premium border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-primary" id="port-modal-title">Add Position to Portfolio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="resetPortfolioModal()"></button>
            </div>
            <form action="{% url 'stocks:add_to_portfolio' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body pt-3">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Symbol (e.g. PTT.BK)</label>
                            <input type="text" id="port-symbol" name="symbol" class="form-control rounded-3" style="background:#f8fafc;" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Category</label>
                            <select id="port-category" name="category" class="form-select rounded-3" style="background:#f8fafc;">
                                {% for code, label in categories %}
                                <option value="{{ code }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Asset Name (Optional)</label>
                            <input type="text" id="port-name" name="name" class="form-control rounded-3" style="background:#f8fafc;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Quantity (จำนวนหุ้น)</label>
                            <input type="number" id="port-quantity" step="0.0001" name="quantity" class="form-control rounded-3" value="0" style="background:#f8fafc;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Entry Price (ราคาทุน)</label>
                            <input type="number" id="port-price" step="0.0001" name="entry_price" class="form-control rounded-3" value="0" style="background:#f8fafc;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-link text-muted" data-bs-dismiss="modal" onclick="resetPortfolioModal()">Cancel</button>
                    <button type="submit" class="btn btn-premium px-4">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    function resetPortfolioModal() {
        document.getElementById('port-symbol').value = '';
        document.getElementById('port-symbol').readOnly = false;
        document.getElementById('port-name').value = '';
        document.getElementById('port-quantity').value = '0';
        document.getElementById('port-price').value = '0';
        document.getElementById('port-category').value = 'STOCK';
        document.getElementById('port-modal-title').innerText = 'Add Position to Portfolio';
    }

    function editPortfolio(symbol, name, qty, price, category) {
        document.getElementById('port-symbol').value = symbol;
        document.getElementById('port-symbol').readOnly = true;
        document.getElementById('port-name').value = name;
        document.getElementById('port-quantity').value = qty;
        document.getElementById('port-price').value = price;
        document.getElementById('port-category').value = category;
        document.getElementById('port-modal-title').innerText = 'Edit Position';
    }

    // Markdown Parser
    document.addEventListener("DOMContentLoaded", function() {
        const reportTextEl = document.getElementById('ai-raw-markdown');
        if (reportTextEl) {
            document.getElementById('port-analysis-content').innerHTML = marked.parse(reportTextEl.value);
            // Scroll to the analysis if it exists
            document.getElementById('ai-analysis-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });

    // Export HTML to Excel
    function exportHTMLToExcel(elementId, filename = '') {
        var preHtml = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:excel' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML To Excel</title></head><body>";
        var postHtml = "</body></html>";
        var html = preHtml + document.getElementById(elementId).innerHTML + postHtml;

        var blob = new Blob(['\ufeff', html], {
            type: 'application/vnd.ms-excel'
        });
        
        var url = 'data:application/vnd.ms-excel;charset=utf-8,' + encodeURIComponent(html);
        filename = filename ? filename + '.xls' : 'document.xls';
        var downloadLink = document.createElement("a");
        document.body.appendChild(downloadLink);
        
        if(navigator.msSaveOrOpenBlob ){
            navigator.msSaveOrOpenBlob(blob, filename);
        } else {
            downloadLink.href = url;
            downloadLink.download = filename;
            downloadLink.click();
        }
        document.body.removeChild(downloadLink);
    }
</script>
{% endblock %}
